// Copyright 2016 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"errors"
	"math/big"
	"testing"

	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/crypto"
	"github.com/theQRL/go-zond/rlp"
)

func TestShaghaiSigning(t *testing.T) {
	key, _ := crypto.GenerateMLDSA87Key()
	addr := common.Address(key.GetAddress())

	signer := NewShanghaiSigner(big.NewInt(18))
	tx, err := SignTx(NewTx(&DynamicFeeTx{Nonce: 0, To: &addr, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil}), signer, key)
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(signer, tx)
	if err != nil {
		t.Fatal(err)
	}
	if from != addr {
		t.Errorf("exected from and address to be equal. Got %x want %x", from, addr)
	}
}

func TestEIP155ChainId(t *testing.T) {
	key, _ := crypto.GenerateMLDSA87Key()
	addr := common.Address(key.GetAddress())

	signer := NewShanghaiSigner(big.NewInt(18))
	tx, err := SignTx(NewTx(&DynamicFeeTx{Nonce: 0, To: &addr, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil}), signer, key)
	if err != nil {
		t.Fatal(err)
	}

	if tx.ChainId().Cmp(signer.ChainID()) != 0 {
		t.Error("expected chainId to be", signer.ChainID(), "got", tx.ChainId())
	}
}

func TestShaghaiSigningVitalik(t *testing.T) {
	// TODO(rgeraldes24)
	t.Skip()
	// NOTE(rgeraldes24): url not working; original test vectors are not of much use
	// Test vectors come from http://vitalik.ca/files/eip155_testvec.txt
	for i, test := range []struct {
		txRlp, addr string
	}{
		{"b91c6602f91c62010380018261a89855f129a54149f8bfa08fe8d1159f78368af3de97647630830a825544c0b90a206c5c0256b7e67cb7e89b75395082c19cf08a31bdb0cddaa0dbf9099951f1eaba6b78effac950c20e2f10a07e53303e56ca0228685effffd57eb45677935753560cc2301fcf56c73a80684609704b96a50bb25921492b1fd20ee2dc796d4a9f0c6d1b21875c28081e722470236636ab762f8f7b3451f1c5d1865cd6bc75f9e063a93921f4c263413956931d4e4b951bf0c0915f130f32e9334efdb6df5e761a981e0be8708c07d4948643f85862adecad1008ddd0fd166e7933230d8683944959d99f22b61c59542e90caa92c43a1dabda2259029fa798d2aa4226af07ebf1de625603d173833064141bafeb367f2a5df2c177f229dacc119c5a94649a897a01289d4e0d4ace80868153c96fcdb03b4f3c8aa8fdd6b8ab74366322454e400fd2301e30912f6dccaae2647bba0f4b2e893c50f24ac81fb2b9f2fd6ccb8f4e6e1438054dc0284650ba99320654140da53bc57b927bdea089557661056290d826c547483839f8ab77467d959ea0a4bdcbd955b96e27e1d775ce35550f5dfcd8c4347609b75f8fc9746ceecd2da06f36803988a9bf902ccb27c1602333cdb9ff2e4409a7993fc5b54d5d57d1de56564e0885f1d71ee7144df744b0960f753d973d832cc1b7b761282a366abc3a42866b26b8c84518fa05d6a152f017e9bcb466575a470db29f5d7451ff3ae88ff706e9b71e2da68b4eafb82cda58b7ca208685e4c4caeab1ba4a79622e85c08826effe2224f2f16bde95b6a7cccde9b469e9b991e4ea8fc3f1eb54a8fa719af71d321d7b893e3751173f9ef2c48200695f1e29b17597dd5450dd43b3a04042c38f2c602c88ffa4e3e96f1611a43ff6c6734b63f685a9818c9354b900c2d2474afae0728e69e0ba93a9d8c782011fb51e7c6728fb940fef69701a9b32e8527c0a47f8a70f896f5700219215e78cd776ef5079fb6ed9caf20f93c50e20a6e3e7bff8c9b7bbd800e1e59139a3ab3aa5d4018dcbc7095b0d017b77185cc5400693992b1ce633b8d0406b3ba97573108cff5a897b06992bd6385ab5f3537f20d607788d4f0f956103506a0337295915fbe02851b9fcf32e8013a9b433c3250f072571b148436c898e6e78bed671c37fc467491254f68debe627b114c5cffeb1935312fe5abeb4ed22771a35f4aae9b64399908d4be447566e4bddb5ebf2b3837a9b99a7dc59cadba535a77814a43000464cb35a2998688fb2ad2eb66ed367807c9d92e9d776ad2895fdaf12d37cd8c61ff46d027d9adfc0316ec5f3b52f80af2614b18f1d7bdbbda4dc35ba5363d960399042efc1a1fd41f860ed1422ee84e73dc12f1f2eb895d59660c11b1edb72509e5b2212716b055fe52e5a58c3e9b5d22c6d9dc4ca2a1f205d65bc4f9f24f44c72cf42d9b8b91c65858332bb24324b47877aafa523f880cd4724ff990cd2b079105071df7ee90692f43ce23e71a8bc0745984e652b65e6013385e81d44563491f546b0064e9cfb7643da4393cf6b3a7afd4fec232016700c65a8531a88e213a9ab5546255528fc0ac9992c46c1f2ac3192adc32423dbe052dbe33e46aa6d369717c74da5a8eea8e8e281b1f37c8352d2879e4ca9b8e3e0ea3454744ba8bec5434cd3ade1c783085a3dfeaeb90703cca8d0b9fcd9ea063b2ae88ded6b84f9a1498252483a5c7583756631da66bf81ec480478204731baff7f2f2e8cd6ee8a2a76d1dbaed7a8254eb002cc18fd65b57f7982176242e546fda668458378e52eb25ccf149ca097381a878643a34c811d4391474d5d09f5d4317815fc02095cda18372d72ed60d35b70c6554bb91dd8ea4a948ffbeb1bbb130b1109cf4d1702070bb8c9572674fc1df859d9aac67a541af321aa518b1d0de130621141f6be4ffc9226afff782cd2ebb9b1f87162cb32c7df2ee2931a55dff603dda6f81bc1858ab48044c1e6c45c3740c8386d8c357ec0d9dc0ff9ddd7f38ebab0e9f6e6d0f23c944a059109d332e35d2b786fde3df1975b761cef5d52df5f837315c1218d9003ea916f3dd98f926eec8781dd92e726752095e2388cac1a3c8b41da90af4942f8e734105d3b8cba0f310dd38267d2d53e0aa00780efcebbc267ff9bebc980918bdd1b4f42655d0671de9b762ea98ec55fd5d07bb102aeec85903f6653f47ee4951213170bbdcf35a276e0fc4a10df4077b14e9c326890fc502dd5422fc601ad76d45e2ac2f9cdcf1802b4fd2f54af989b0c4087feb032dda3fac5b292af1fbe53013acf162d0a7cfd908d7be37d78904161a04e6f67a63350936ba9d0a94b9400777a3cf2e5c78fc9ea4d0b2de1bd80bed2f0b2201d78a45f37099f912da6698f6bc1eb5a98bf11bd7f3a06fe95a7211a52410913d5ba04d1f80ae24fc499d380980b324ea617def1fd7b90e15df83cd0233f9cbf603aeb41f8f2f3d796596edbca55d385e2620542ecf4fddcee771a69642e7c7bbd2b20acf2774f3e9b0e9adae01ddb5925350b9977ea53071b0db3306dd6dd7c667225d540595013398205381501203bb05bf7c44738936014e1ad5214e2f26059d11f986bdc234f9da8860548e1ede1ca0bf87a010b503f2346610137bc7df2295bb5de4d38c5dc73a7738294232cae9effb82e5a7f012f7b15e223925fb9a1b998545efc28b76a2d9361d545d603cbcc019f70ff073d16c5e2727f123d95eb42339ebac494ce7f28555aea065e6161486fde260a02024f15af6592892934e9fab09025c0ac606e0491e965b58d1dcf60058059e4726728e037a698cf74bf2f2f0f4f9bec51cbc035f32eb3e617cb892af5406e6f3ee74e177a1bb07d1d3b5f80cba842d6d2e7eeb5b2ad7bedb0d9f5e6255033b1bc187064b19b72a2eb926961be1441426200ce27893e30cc217e0a8a9c33fdc22e7c94b49ef094443fca1e528035ec04c83f187686d22862ffcd9edf223d2d1d86da65a597f9f1b784395541bb5d960c1bbc34d0c15404182b3746f875b06bd5f4d41ccb58ed03de6df566cb85595b21ce3bd7062a515bc365c925965e8800263731618f70258a731e41eb45a7d8e19cf18ee8ff0eabb0dd7c89e0f6aacce42dfeee14704d53105f81b627fdb6399c23d330d8ed169e4a76c3d4158016afafdade3b725bfbfcdd8457eef2a8f8566908da236e3a0b35486e0cc979bdcef27329d354624f346a308470d813b28d204b7fab4613243b37ccf92b347390d1da0bf902cd4803a9aa54fd46fc85ff63cae54ce45785aff19cf6b1cf7ada4f3fdaeafc8989e7c9221efc0d5048c6b873bb9951729f92aa097393726a1e904460eb6344a7f4c8d680c0bafdd2f80ac559d82b4970153b87fb7724ac9c92a8dd35c8ebaff1f3d99202d8456d3ed4fa8728f1d4901c883e7cb26dbf804871e4170b6e274c1514d5a64b3c8f4bc70ee41bd0bbc44c1ae016e9bcdf6e71158d37623cf40a64cdf9fb4c230ca8680cd74d49de200acb00ea38117dd8cb246d421b29c355de0cee7b0de003e3c55821a067d8b0b5f8b01a4e5634e48131578a89870e059fb4794d45ba0713179a545a2ffa43d92f178dcf7c6f05c80aca3a6b16419f8d9f6d118caaa5a59535b3211b8ab651de3444ff1205c38df1f7d6b6bf96e04a7d2141a248e0b39619f3da001c437ea752d9c1605d4c11950ffeef401dd3608f368b4e365e9b912133539f14a36e5edeaec2c99da0691cc282ee263d5e90ab4cfaf4b05e9474e69cb7b25d7a4f8637d696d3b12cbccf765b4aedefb949542f1abcbfdfb651284f7f3651f1b9960d7b04092caec6c69efc8ad83fc9b00c9d18d4d117c45b76a0a700f32cd68cd78241517a0d0d334c962df3e13f31f4299a677fe41c8dc384d9d29d11184b7d5c0ad24b9301406642b2034cce1ab1dbefe8c082cd072d1328d05336e6a72df2627647f32785d2da66cf927d01b01d4cc1f52fc1ac24022689e73bb9d4138e7b26913ad84d8102869dfc06defce696ba420a5135f7f5454f04924e6b9e25d1a2f9f97be41a35988bdef5a2c8f1d56111370e00a7f9378f3fcea00075178edfcfba5d40384795acb11f21bb4a944e1358d82b636048c55e491090894e5a8b89b110175ec07c0732e5780098cc8319ab75033f8aa4baf5784f29d8821240e4ef915dba1a2f157a433f29acfb82781fa13bdad0a7ad4be67399f1c083333f5e1b3c3d89fcf38478e745494646ed6e54f8d1cfa331028219fa08f1c9f132ebe18900f8aa7b877b01aa06002adde361afb33d10e5d0000187e2df825eb81618642a8ac01dad889cfac612873053e65bc1b99aacbfa435f894f248071e301fb6f727fcd9fceaf1ca4fe82e6d92535e056365d0f67940f0af51c63f364d3e156640393d64388baf57cbcb08f9b9f0282abafc79e5e1ca71562c6140d0c5b4f948302188f2fa50141f2294e9c7c49fa92d35069623bdae2f8dd923f49afad63add4e84558734522fdd429551343ff0d266423ddd108c6800049ce4d5dfdbfe292c61e20d5eba67d02bca6793267c16e2063a21bbcba5099134c57a54bdaa83f300eb4f3d8a1750c38f28833bcdaaa24921049f7fa91a499afccc2e410200dcb019c0a5ecc3ec8d3ca84192b57d18491ba143a51e68966355694b9118459e71316e026cb7b2b104350db9c929cf7d9f511e32bb68179ee83774cf00c61070d0ce247afd5c0d8dd81d9387bee9fabfeed000039545f5696404b31247a050d2fc77b2e2ebaaf1b6c74303bffd84b4fbc103c4906b2a851950057998f7f219a2982100d45187de8254fca43cbf036faf9771b362c29a33a2e746f2cd8f3096149e55e0153953d6e600cb3cfaa55e87db29d537c9508d1b4c832a2c4a0de55598b2710940d082b8c9fa2ae6a552ccfa13de351b511088c90096999a66550aabee6f7f276937fa25a656c2d9704edbaa4e493e40bd8ef8846005b5e685e196836fd0e96cbdaa66387532a7afef1d0571becac40517f43c7fbfea3004ad61694ccb14e27e73739ccb8a7758bb15faed667136c9d3413b3f3d928721ce8ab40f121d052691962221027e91906be58ddbee52ee801b47ddd6543be09a62217245b6ff0f2435f7d747b7223afba34adc2fa895f146a837a9f98d2ce00d85b74b09c74cea033b9dc0003488a296158e78b42ea31b1b57d8ee76f845b0f3728763db929686384de1e6f529660f8b9b2e3c5ee00060755d9badfa9c1e82dee61ac23304b4a92c7251afbb3faef1a8baaf54899fb84c81db96704bf6639300eb60f260cef52629f7ff8dc78e8c6cca1620c2fce2fe50aa65fbebc40ffad6fbb86781856122743a715e124acfd9442a6d0e5e78d3709b3b569a784077e185b44cba252ff258a7452e86e3bf49010f7d634d072c3ced5087f1c7524944ae3fddf72df716984379f70d31f006715ad2d11aa9e1d1ea0a559898efb4edc6df7db80c05a8260f8722cbbab01624e15469b9a95178328f5f9ad3e1a39afdae50894d72ceb3f8508afc73027977402d5636a487292dfdafe71e80216b44d1628ed1479377a20065ed3a54820752f9aa488c78becaab3a7b8f1928f810a620c836dea7e02258fc06392c18b5d00b1800c9a1a1f625531e677bff51d7177abd6647f8912e173be3c77effcf124779efcbe3e9669bd75ac506582abd6b421d24fbc74d979c559c605a53fe3ff6f6eb87ec650ca0cf2f10b01c50398b0b8042604ac8a42b254c3c161b1494a761d64ba9fca91a8e954a0e277928cf82da90908896607185a1b55a09e14e369554db2f4641a8942db80d61c9022732b6a304f64f21cdf245118080b808462320b410ffdef9acd8ac6972701eed9b8a4648d7ede8f89093a65e078d0961cd09e8eeead15627725874797f8161727d869295483beb52a247050c05175b521e1d5170d06c857372378c40d826a40b8937d4dde84ce4120f1972030a3f171a16e606f1ea227886c3cee8861dd14492184c6be6f01dde3ebb5a24effcbe21feba36711053fd22a69d2dae58c9e7223d5f38308b69f9ac12530aa3f8e7d3fe533038506cb2390e511a9e44b994afc8fc3dc05e1298179060fc4b56081533867fc8d55e636d0870a0bc0b51daa22c7733dfa0c1e75c70b21f30bf4976db36a174774bb7d660aa11c588fe41d599b79b294cbf2349b877ed92fb766903ad82989df9e96827bed0b3c48b666d1dedcff1e168293f76603d6fa814c299e6571d063ec2edaff07b21ca4c44c47c219858de39e2439ad949a252f52ff06ef3206967c5e4ec11a45380a1c6446e96306e3dbee8756f3070ebf49bfb8c6c55084ec249305461d5dc708d2b63535d40e377f2482bfcc916d6210acd1980b53bfb9fc65ef4a14ae9846c6fe29ef67b4d75f245e1cf2f41bb8727459e6aa787407e86562a1b2b25641cf72882dd972e63f1f3b31b049a81f1d6967b6bc2d01b7346e70995ef87a55f181b8f96e58c1c8b6611b07a691380dc35316f1c2043319c6d99f0dabf6073b388d62ca12f335b2099f1f246bf8b5fcfa77cfaab2f4a6a42570588805c7153ecb9e2adf64e509d7cf3a08a4ff441830ceac0c836bb66ba1df0cd9d48f3f885b7b17d16fe9e06124631c0c78a2b4ec30d03ec15413b4c689f4757691775f172faa0cdbb37e22245d33a0648d22d35420af68d64adaf7a6ceef1ffa581a6c1c850869f4a5dbcfc532b39d637053983f18ed26b1d584d5cda44744719fe83e6ceefce07690da5058ee03ef63c9b89a60c2d47bf305387010d62bc7b035c1b44c5a15c3b65056535877d5d28325469fe6d2f1516c9952d3c4dc904735256836040f4a2063309145c38ff10773f1d371ec9bd0f554c17eaaeae70f9c5fae6139e0102e54dd4cb63633c11df5b53dcf2b054b38dd44bf17f04d4798ad4a7da70debf78f66b30acf96733f79832b2429dff816bde4cfe112958ce4ced810ddf375281bcc51e44d1cc3680336d130d1636f79dadc84f102d59fd7a96841408725801921a8d84cd6220643cd419ce083078241ae8578616692c2523396591480b5a1d4f11b0e15e4c87efff61993aa801f601dbfeeb5d940414a43876b1e5873a727a2af4f1da4dcc9ad2ad9432fe3fb80e31b87943e6693809ab72cbd1db73261fa97f85a8d6ca98ac5e2e30dcb239f79246ea899327859f4130232272b8ff86c5c2b3acab603df0866580ed797f3417331acc78903e7675e1a7d1f8569544104c9dbbb1257d47fca9351e4a1fc09511684001c3b8b64cc248655815c006b1c220e97dc784deb700334c4b7612388222e50c130872431112a3e2912a2df9fc0ba2588007d50afd3c2449d459945d58fb3218b30c2141aa30caed70160b3433575b8feb5afc920abb74da1e6ff471e223a996e7fa73af5a9311cb71acc25941439fbb45e258715ae6fc9985280a67e627b9ee6ac2a7efd33fe7b464edbf7e21414a03a6388817f3b4b91d0d670e59afcc7a7f174414f303ea0c35b9f8f2349219cca1c8eb3c992872579b4865c3cf22e2e204c16e48522cc189d5e406ada77bb83efb8798e0e89057cdab0d56fe46af60f7c30b1ad960db90330884f663f89f7525e7874726d027dbabc58421a001a6f8a3efc5ced0c179982d2aa5951eb7aedc87645e86ff77c0f289d89a5c93807cb8960e6aef74dda7bc48c72bf0bb6292923f5bf6aa87825198c51305d9f4e701beb1434a8c2279b1021102224f2b91c4acb0be73dfaba2da6398ec10a3f586ccd2234c119b4ba32bf97d6292834cd23a52d234d31bcf8bb07cf907c8761ae9023477e6f858fdf8fb0c903c687d2cc77ba008bd4218309c75e6c59b456d4dc7c403838634b2792d2cedbdcc0903dbde7314093987a31835917c3bb4c3ce55c971a81c81fabc697d103ff32eacc378f4240b712811a4a862d9de3cc86fca04aece32020e727c832996b2f19ac95619c57b30b3557ea7b8197ad7f956e58dc4ecce90b875d1319d4ea24eefc3bcdd24cf04e0ebe5c65c42d2b0420012c187d671e0faaf08b36ea588d43012e107bdcd6ad0debdb2047b2fa9282d6615a3aacfdba5e0cc744a0b9558c40f68a45a6e078214d24e33af39db56fb152db390517f0586699d06199eba1ad5c892ccfa5c07fadbac9c743647d764dfd19b8525817b31027ccdeb357cfad7ac84a31b59cd978ca759616888c197fa3c2cd0ca155c9351173d573e493cce1d71c901fdd06c81d60e86c0b10b2c2fdf9816caa893cae9225a97a90bde037242541419f754e0a61f615369894ea9d74172d6c1faeac6fdc852b2f961a89a0206f39616ec9cf19c0da85d7e0b9d7c9e315cb6f328fa4f7c821ee0294931a96c1bbff5476017bfc57d8f67dd7ccdf62751a15828bc5622cee9061d9c2b1661950b070bfe766b8a0a96fc435261ffd91aa69e32244fd6e3c7f64f0453d0401393259d852253daf5672affd1e4ca8dcdd69bca9790b3c164061e957e88ae1821edf10c97b68dbe48b61b08b40c3e661d3a5d438e96e5f7cc011882c79d844db7c1085adfac8a4dfa3e27dea76c2983096fbc25f0f3d15a89ee5038da638e6687b71f75612eaf8693bd9043813ae929f9d9819562968b0b9914f0f7a148f3b29106cf64b285a4ff532b24d39700a62c36b155f08a0a07de71296e493ce363f71f263829c688ae4ba9bb9fbbaecb9c8a25e1209f02e700dfdb07f310b391fba531eceeed2acc4c146a8d397108b8058044b8f1960b5bfa911a717c01c3b9e34028fa3166bbf1eccebe3def3fa7d47a02d3dce471b03474c5561412236521358561e3cddd0bc912e4d8240dcc8f7bee56bfab38e61d043ce626a736e327a8efa2f5c62032a176a86d960643c1d372ef02397e730631387074d08ec5cf1ff5a86650d65c3ad21270f9ebab900b9e55240db39ae26df656dd91701653470f6c59af84c06bf08c50ee8688cd27f5b177bd34792c2ccb46245ff7b8b2ad9966d356512d115651b66c9ca89b3194a87b6925158199005ecafbaf3931163b192d6e607c8af534d64306cd551b6164033263fe660be99c97b872a13a41ca37ae4258a14a617a11979c097dabcddee949169dce656da90f9be561781f73a6bbf1370971e2eb1c4ebde5bed156f9b97adfa7119e8a89cfd4d44c2a790c620024a91f191040de2e5ae800d0794010432db813e085300da4c98c4a7cb1d4e23cf296697e6446413b7bfcf8dcc731feb4a0a1cdcfb229dd6269b874b6f56173b37e0fd172389def6372e2c07dfafdcdee72d89c010dce90d4559714c56137fd450bb763d15e06c9e0203f3c5a918742bfc5becccd1253c909edc42ffc943545849bb15502b1202de69a70cc272e9868662ffd11daefa12dc4769bf1f2e13f39160dfcccd3ff230eb8d48eb200039fc1b22dc116e8732901f2d92baabbdbfb2197c3125503189a1eca2bace5be6d1f9c43d6ca303b7333cafa420f2ffadb032f50c7603e5ee469d5df6f1ff208c20a6adca6501af37dbf0f353e2c5ac01ef30afc2991d1a0cb5a1789dc89922c333e401da07503938279ee363c3900f2b4900e41bc1277a4a5f8da9fac86d0186652048ea041711ec6d61db69775d2438eefb89546d6571b963c69b10b7367d985b26588417d9c87cd6b9debea4d2baaebfda7beb8f39ad638da8094f86e992c0ecffdce4d50a4026979ab6476c92e12a0c876233f8e860a3776b1831a03f4cc5233aeefeb3a67422366ce65636769698d1a5d7241e4760cd52be5fd550eafc83034fc366343b3e37ee45df3e9991921165b0d4309910553f3be7840c63b888f576fa98284a592efc97ad92e4da35cc4f5548e8184ecff18d51db08dc0dd267be2e586f39d3cde70b1a8d017ce32fbc3930664703f22f73635598358cfe5a687e28aa224cc8724671152380c78fd6e4496bba23cb2a21bb26458f2a77c1921c7ccd465fc11d6fa52e421edda8506cbc464813881a3e3119fca89df22f6cfb9157b4317ca1b0bc67e2b47c5901ca7832f35eef5b38fdda89e333b85ba99ec7de8e2d86f12c5646dc5ad4e40464f2d7672e86a3f1e270fa762be3b28074e6801bd0a922d9ad69f224da2dbba4e0c329f053d3635e20f11175b6a7be9df763f92f07f1336b566eaf1157a87b62397782b5de4463a3d0d2e7020d172a2b787c8c02242c7211122f64a1b1102ea50103232b324e6ad31b2e44bad8fc0000000000000000000000000000000000000000000000000000000000050b13171d20282e83010000", "Q20B045A50E3C97dcf002eeFed02dB2dB22AE92A0"},
	} {
		signer := NewShanghaiSigner(big.NewInt(1))

		var tx *Transaction
		err := rlp.DecodeBytes(common.Hex2Bytes(test.txRlp), &tx)
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}

		from, err := Sender(signer, tx)
		if err != nil {
			t.Errorf("%d: %v", i, err)
			continue
		}

		addr, _ := common.NewAddressFromString(test.addr)
		if from != addr {
			t.Errorf("%d: expected %x got %x", i, addr, from)
		}
	}
}

func TestChainId(t *testing.T) {
	key, _ := defaultTestKey()

	tx := NewTx(&DynamicFeeTx{Nonce: 0, To: &common.Address{}, Value: new(big.Int), Gas: 0, GasFeeCap: new(big.Int), Data: nil})

	var err error
	tx, err = SignTx(tx, NewShanghaiSigner(big.NewInt(1)), key)
	if err != nil {
		t.Fatal(err)
	}

	_, err = Sender(NewShanghaiSigner(big.NewInt(2)), tx)
	if !errors.Is(err, ErrInvalidChainId) {
		t.Error("expected error:", ErrInvalidChainId, err)
	}

	_, err = Sender(NewShanghaiSigner(big.NewInt(1)), tx)
	if err != nil {
		t.Error("expected no error")
	}
}
