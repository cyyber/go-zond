// Copyright 2014 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"bytes"
	"encoding/json"
	"errors"
	"fmt"
	"math/big"
	"reflect"
	"testing"

	walletmldsa87 "github.com/theQRL/go-qrllib/wallet/ml_dsa_87"
	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/crypto/pqcrypto"
	"github.com/theQRL/go-zond/rlp"
)

// The values in those tests are from the Transaction Tests
// at github.com/ethereum/tests.
var (
	testAddr, _ = common.NewAddressFromString("Qb94f5374fce5edbc8e2a8697c15331677e6ebf0b")

	emptyEip2718Tx = NewTx(&DynamicFeeTx{
		ChainID:   big.NewInt(1),
		Nonce:     3,
		To:        &testAddr,
		Value:     big.NewInt(10),
		Gas:       25000,
		GasFeeCap: big.NewInt(1),
		GasTipCap: big.NewInt(0),
		Data:      common.FromHex("5544"),
	})

	signedEip2718Tx, _ = emptyEip2718Tx.WithSignaturePublicKeyAndDescriptor(
		NewShanghaiSigner(big.NewInt(1)),
		common.Hex2Bytes("1b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd0000000000000000000000000000000000000000000000000000000409111821242930"),
		common.Hex2Bytes("98d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3"),
		walletmldsa87.NewMLDSA87Descriptor().ToDescriptor().ToBytes(),
	)
)

func TestDecodeEmptyTypedTx(t *testing.T) {
	input := []byte{0x80}
	var tx Transaction
	err := rlp.DecodeBytes(input, &tx)
	if err != errShortTypedTx {
		t.Fatal("wrong error:", err)
	}
}

func TestEIP2718TransactionSigHash(t *testing.T) {
	s := NewShanghaiSigner(big.NewInt(1))
	if s.Hash(emptyEip2718Tx) != common.HexToHash("51f7a3b00f7d2177701293974ebfb09909790f78c1155412051b67b699d90d82") {
		t.Errorf("empty EIP-2718 transaction hash mismatch, got %x", s.Hash(emptyEip2718Tx))
	}
	if s.Hash(signedEip2718Tx) != common.HexToHash("51f7a3b00f7d2177701293974ebfb09909790f78c1155412051b67b699d90d82") {
		t.Errorf("signed EIP-2718 transaction hash mismatch, got %x", s.Hash(signedEip2718Tx))
	}
}

// This test checks signature operations on access list transactions.
func TestEIP2930Signer(t *testing.T) {
	var (
		key, _  = pqcrypto.HexToWallet("010000b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		keyAddr = common.Address(key.GetAddress())
		signer1 = NewShanghaiSigner(big.NewInt(1))
		signer2 = NewShanghaiSigner(big.NewInt(2))
		tx0     = NewTx(&DynamicFeeTx{Nonce: 1})
		tx1     = NewTx(&DynamicFeeTx{ChainID: big.NewInt(1), Nonce: 1})
		tx2, _  = SignNewTx(key, signer2, &DynamicFeeTx{ChainID: big.NewInt(2), Nonce: 1})
		to, _   = common.NewAddressFromString("Qcccccccccccccccccccccccccccccccccccccccc")
		tx3, _  = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:      common.Hex2Bytes("00"),
			Value:     big.NewInt(0),
			ChainID:   big.NewInt(1),
			Nonce:     1,
			Gas:       4000000,
			GasFeeCap: big.NewInt(2000),
			GasTipCap: big.NewInt(10),
			To:        &to,
			AccessList: []AccessTuple{
				{
					Address: to,
					StorageKeys: []common.Hash{
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000000"),
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000001"),
					},
				},
			},
		})
		to2, _ = common.NewAddressFromString("Q20a1A68e6818a1142F85671DB01eF7226debf822")
		tx4, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       common.Hex2Bytes("095ea7b30000000000000000000000001111111254eeb25477b68fb85ed929f73a960582ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),
			Value:      big.NewInt(0),
			ChainID:    big.NewInt(1),
			Nonce:      47,
			Gas:        53319,
			GasFeeCap:  big.NewInt(14358031378),
			GasTipCap:  big.NewInt(576312105),
			To:         &to2,
			AccessList: []AccessTuple{},
		})
		to3, _ = common.NewAddressFromString("Q20B045A50E3C97dcf002eeFed02dB2dB22AE92A0")
		tx5, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       []byte{},
			Value:      big.NewInt(73360267083380739),
			ChainID:    big.NewInt(1),
			Nonce:      132949,
			Gas:        30000,
			GasFeeCap:  big.NewInt(14237787676),
			GasTipCap:  big.NewInt(0),
			To:         &to3,
			AccessList: []AccessTuple{},
		})
	)

	tests := []struct {
		tx             *Transaction
		signer         Signer
		wantSignerHash common.Hash
		wantSenderErr  error
		wantSignErr    error
		wantHash       common.Hash // after signing
	}{
		{
			tx:             tx0,
			signer:         signer1,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSenderErr:  ErrInvalidChainId,
			wantHash:       common.HexToHash("b7528638c6ed144ebaedc7132ba5be318a5bee800b3fec5849280a5710ca645c"),
		},
		// NOTE(rgeraldes24): not valid atm
		/*
			{
				tx:             tx1,
				signer:         signer1,
				wantSenderErr:  ErrInvalidSig,
				wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
				wantHash:       common.HexToHash("1ccd12d8bbdb96ea391af49a35ab641e219b2dd638dea375f2bc94dd290f2549"),
			},
		*/
		{
			// This checks what happens when trying to sign an unsigned tx for the wrong chain.
			tx:             tx1,
			signer:         signer2,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b0759fc55582f3e60ded82843dcc17733d8c65f543d2cf2613a47a5c6ac9fc48"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// This checks what happens when trying to re-sign a signed tx for the wrong chain.
			tx:             tx2,
			signer:         signer1,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// qrvmone example
			tx:             tx3,
			signer:         signer1,
			wantSignerHash: common.HexToHash("ac24e88927be91432ead6d790413a77625e3c6b0318aed7fed4171a1553e0793"),
			wantHash:       common.HexToHash("ef05cdf105fa60c2110efd3859ee3ba22e325253216aa1608277132a4079c8ce"),
		},
		{
			// qrvmone example
			tx:             tx4,
			signer:         signer1,
			wantSignerHash: common.HexToHash("a4a638eaa524a986942beb4e897a63f3f12509517c7ea510b7ae235806f96c26"),
			wantHash:       common.HexToHash("a5e3452b9ce2affdac56c666a4625b72ceef6fde4bc55e4ae8cd5d626336cbc1"),
		},
		{
			// qrvmone example
			tx:             tx5,
			signer:         signer1,
			wantSignerHash: common.HexToHash("2593e06e27020b889cb2eaa7dc6e650d83f5a8de5226a797f6154c598821ef19"),
			wantHash:       common.HexToHash("5fa0ce9d0ecce9eb0600ae7057c73df8dbbae7dc36a6de3f6a281ce54cef9a66"),
		},
	}

	for i, test := range tests {
		sigHash := test.signer.Hash(test.tx)
		if sigHash != test.wantSignerHash {
			t.Errorf("test %d: wrong sig hash: got %x, want %x", i, sigHash, test.wantSignerHash)
		}
		sender, err := Sender(test.signer, test.tx)
		if !errors.Is(err, test.wantSenderErr) {
			t.Errorf("test %d: wrong Sender error %q", i, err)
		}
		if err == nil && sender != keyAddr {
			t.Errorf("test %d: wrong sender address %x", i, sender)
		}
		signedTx, err := SignTx(test.tx, test.signer, key)
		if !errors.Is(err, test.wantSignErr) {
			t.Fatalf("test %d: wrong SignTx error %q", i, err)
		}
		if signedTx != nil {
			if signedTx.Hash() != test.wantHash {
				t.Errorf("test %d: wrong tx hash after signing: got %x, want %x", i, signedTx.Hash(), test.wantHash)
			}
		}
	}
}

func TestEIP2718TransactionEncode(t *testing.T) {
	// RLP representation
	{
		have, err := rlp.EncodeToBytes(signedEip2718Tx)
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("b91c6602f91c62010380018261a89855f129a54149f8bfa08fe8d1159f78368af3de97647630830a825544c0b90a2098d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3b912131b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd000000000000000000000000000000000000000000000000000000040911182124293083010000")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
	// Binary representation
	{
		have, err := signedEip2718Tx.MarshalBinary()
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("02f91c62010380018261a89855f129a54149f8bfa08fe8d1159f78368af3de97647630830a825544c0b90a2098d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3b912131b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd000000000000000000000000000000000000000000000000000000040911182124293083010000")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
}

func decodeTx(data []byte) (*Transaction, error) {
	var tx Transaction
	t, err := &tx, rlp.Decode(bytes.NewReader(data), &tx)
	return t, err
}

func defaultTestKey() (*walletmldsa87.Wallet, common.Address) {
	key, _ := pqcrypto.HexToWallet("a7b1a3005d9e110009c48d45deb43f0a0e31846ed2c5aaefb6d4238040ad4c08794ffe65585c13eb6948c2faf6db90c2")
	addr := key.GetAddress()
	return key, addr
}

func TestRecipientEmpty(t *testing.T) {
	_, addr := defaultTestKey()
	tx, err := decodeTx(common.Hex2Bytes("b91c6602f91c62010380018261a89855f129a54149f8bfa08fe8d1159f78368af3de97647630830a825544c0b90a206c5c0256b7e67cb7e89b75395082c19cf08a31bdb0cddaa0dbf9099951f1eaba6b78effac950c20e2f10a07e53303e56ca0228685effffd57eb45677935753560cc2301fcf56c73a80684609704b96a50bb25921492b1fd20ee2dc796d4a9f0c6d1b21875c28081e722470236636ab762f8f7b3451f1c5d1865cd6bc75f9e063a93921f4c263413956931d4e4b951bf0c0915f130f32e9334efdb6df5e761a981e0be8708c07d4948643f85862adecad1008ddd0fd166e7933230d8683944959d99f22b61c59542e90caa92c43a1dabda2259029fa798d2aa4226af07ebf1de625603d173833064141bafeb367f2a5df2c177f229dacc119c5a94649a897a01289d4e0d4ace80868153c96fcdb03b4f3c8aa8fdd6b8ab74366322454e400fd2301e30912f6dccaae2647bba0f4b2e893c50f24ac81fb2b9f2fd6ccb8f4e6e1438054dc0284650ba99320654140da53bc57b927bdea089557661056290d826c547483839f8ab77467d959ea0a4bdcbd955b96e27e1d775ce35550f5dfcd8c4347609b75f8fc9746ceecd2da06f36803988a9bf902ccb27c1602333cdb9ff2e4409a7993fc5b54d5d57d1de56564e0885f1d71ee7144df744b0960f753d973d832cc1b7b761282a366abc3a42866b26b8c84518fa05d6a152f017e9bcb466575a470db29f5d7451ff3ae88ff706e9b71e2da68b4eafb82cda58b7ca208685e4c4caeab1ba4a79622e85c08826effe2224f2f16bde95b6a7cccde9b469e9b991e4ea8fc3f1eb54a8fa719af71d321d7b893e3751173f9ef2c48200695f1e29b17597dd5450dd43b3a04042c38f2c602c88ffa4e3e96f1611a43ff6c6734b63f685a9818c9354b900c2d2474afae0728e69e0ba93a9d8c782011fb51e7c6728fb940fef69701a9b32e8527c0a47f8a70f896f5700219215e78cd776ef5079fb6ed9caf20f93c50e20a6e3e7bff8c9b7bbd800e1e59139a3ab3aa5d4018dcbc7095b0d017b77185cc5400693992b1ce633b8d0406b3ba97573108cff5a897b06992bd6385ab5f3537f20d607788d4f0f956103506a0337295915fbe02851b9fcf32e8013a9b433c3250f072571b148436c898e6e78bed671c37fc467491254f68debe627b114c5cffeb1935312fe5abeb4ed22771a35f4aae9b64399908d4be447566e4bddb5ebf2b3837a9b99a7dc59cadba535a77814a43000464cb35a2998688fb2ad2eb66ed367807c9d92e9d776ad2895fdaf12d37cd8c61ff46d027d9adfc0316ec5f3b52f80af2614b18f1d7bdbbda4dc35ba5363d960399042efc1a1fd41f860ed1422ee84e73dc12f1f2eb895d59660c11b1edb72509e5b2212716b055fe52e5a58c3e9b5d22c6d9dc4ca2a1f205d65bc4f9f24f44c72cf42d9b8b91c65858332bb24324b47877aafa523f880cd4724ff990cd2b079105071df7ee90692f43ce23e71a8bc0745984e652b65e6013385e81d44563491f546b0064e9cfb7643da4393cf6b3a7afd4fec232016700c65a8531a88e213a9ab5546255528fc0ac9992c46c1f2ac3192adc32423dbe052dbe33e46aa6d369717c74da5a8eea8e8e281b1f37c8352d2879e4ca9b8e3e0ea3454744ba8bec5434cd3ade1c783085a3dfeaeb90703cca8d0b9fcd9ea063b2ae88ded6b84f9a1498252483a5c7583756631da66bf81ec480478204731baff7f2f2e8cd6ee8a2a76d1dbaed7a8254eb002cc18fd65b57f7982176242e546fda668458378e52eb25ccf149ca097381a878643a34c811d4391474d5d09f5d4317815fc02095cda18372d72ed60d35b70c6554bb91dd8ea4a948ffbeb1bbb130b1109cf4d1702070bb8c9572674fc1df859d9aac67a541af321aa518b1d0de130621141f6be4ffc9226afff782cd2ebb9b1f87162cb32c7df2ee2931a55dff603dda6f81bc1858ab48044c1e6c45c3740c8386d8c357ec0d9dc0ff9ddd7f38ebab0e9f6e6d0f23c944a059109d332e35d2b786fde3df1975b761cef5d52df5f837315c1218d9003ea916f3dd98f926eec8781dd92e726752095e2388cac1a3c8b41da90af4942f8e734105d3b8cba0f310dd38267d2d53e0aa00780efcebbc267ff9bebc980918bdd1b4f42655d0671de9b762ea98ec55fd5d07bb102aeec85903f6653f47ee4951213170bbdcf35a276e0fc4a10df4077b14e9c326890fc502dd5422fc601ad76d45e2ac2f9cdcf1802b4fd2f54af989b0c4087feb032dda3fac5b292af1fbe53013acf162d0a7cfd908d7be37d78904161a04e6f67a63350936ba9d0a94b9400777a3cf2e5c78fc9ea4d0b2de1bd80bed2f0b2201d78a45f37099f912da6698f6bc1eb5a98bf11bd7f3a06fe95a7211a52410913d5ba04d1f80ae24fc499d380980b324ea617def1fd7b90e15df83cd0233f9cbf603aeb41f8f2f3d796596edbca55d385e2620542ecf4fddcee771a69642e7c7bbd2b20acf2774f3e9b0e9adae01ddb5925350b9977ea53071b0db3306dd6dd7c667225d540595013398205381501203bb05bf7c44738936014e1ad5214e2f26059d11f986bdc234f9da8860548e1ede1ca0bf87a010b503f2346610137bc7df2295bb5de4d38c5dc73a7738294232cae9effb82e5a7f012f7b15e223925fb9a1b998545efc28b76a2d9361d545d603cbcc019f70ff073d16c5e2727f123d95eb42339ebac494ce7f28555aea065e6161486fde260a02024f15af6592892934e9fab09025c0ac606e0491e965b58d1dcf60058059e4726728e037a698cf74bf2f2f0f4f9bec51cbc035f32eb3e617cb892af5406e6f3ee74e177a1bb07d1d3b5f80cba842d6d2e7eeb5b2ad7bedb0d9f5e6255033b1bc187064b19b72a2eb926961be1441426200ce27893e30cc217e0a8a9c33fdc22e7c94b49ef094443fca1e528035ec04c83f187686d22862ffcd9edf223d2d1d86da65a597f9f1b784395541bb5d960c1bbc34d0c15404182b3746f875b06bd5f4d41ccb58ed03de6df566cb85595b21ce3bd7062a515bc365c925965e8800263731618f70258a731e41eb45a7d8e19cf18ee8ff0eabb0dd7c89e0f6aacce42dfeee14704d53105f81b627fdb6399c23d330d8ed169e4a76c3d4158016afafdade3b725bfbfcdd8457eef2a8f8566908da236e3a0b35486e0cc979bdcef27329d354624f346a308470d813b28d204b7fab4613243b37ccf92b347390d1da0bf902cd4803a9aa54fd46fc85ff63cae54ce45785aff19cf6b1cf7ada4f3fdaeafc8989e7c9221efc0d5048c6b873bb9951729f92aa097393726a1e904460eb6344a7f4c8d680c0bafdd2f80ac559d82b4970153b87fb7724ac9c92a8dd35c8ebaff1f3d99202d8456d3ed4fa8728f1d4901c883e7cb26dbf804871e4170b6e274c1514d5a64b3c8f4bc70ee41bd0bbc44c1ae016e9bcdf6e71158d37623cf40a64cdf9fb4c230ca8680cd74d49de200acb00ea38117dd8cb246d421b29c355de0cee7b0de003e3c55821a067d8b0b5f8b01a4e5634e48131578a89870e059fb4794d45ba0713179a545a2ffa43d92f178dcf7c6f05c80aca3a6b16419f8d9f6d118caaa5a59535b3211b8ab651de3444ff1205c38df1f7d6b6bf96e04a7d2141a248e0b39619f3da001c437ea752d9c1605d4c11950ffeef401dd3608f368b4e365e9b912133539f14a36e5edeaec2c99da0691cc282ee263d5e90ab4cfaf4b05e9474e69cb7b25d7a4f8637d696d3b12cbccf765b4aedefb949542f1abcbfdfb651284f7f3651f1b9960d7b04092caec6c69efc8ad83fc9b00c9d18d4d117c45b76a0a700f32cd68cd78241517a0d0d334c962df3e13f31f4299a677fe41c8dc384d9d29d11184b7d5c0ad24b9301406642b2034cce1ab1dbefe8c082cd072d1328d05336e6a72df2627647f32785d2da66cf927d01b01d4cc1f52fc1ac24022689e73bb9d4138e7b26913ad84d8102869dfc06defce696ba420a5135f7f5454f04924e6b9e25d1a2f9f97be41a35988bdef5a2c8f1d56111370e00a7f9378f3fcea00075178edfcfba5d40384795acb11f21bb4a944e1358d82b636048c55e491090894e5a8b89b110175ec07c0732e5780098cc8319ab75033f8aa4baf5784f29d8821240e4ef915dba1a2f157a433f29acfb82781fa13bdad0a7ad4be67399f1c083333f5e1b3c3d89fcf38478e745494646ed6e54f8d1cfa331028219fa08f1c9f132ebe18900f8aa7b877b01aa06002adde361afb33d10e5d0000187e2df825eb81618642a8ac01dad889cfac612873053e65bc1b99aacbfa435f894f248071e301fb6f727fcd9fceaf1ca4fe82e6d92535e056365d0f67940f0af51c63f364d3e156640393d64388baf57cbcb08f9b9f0282abafc79e5e1ca71562c6140d0c5b4f948302188f2fa50141f2294e9c7c49fa92d35069623bdae2f8dd923f49afad63add4e84558734522fdd429551343ff0d266423ddd108c6800049ce4d5dfdbfe292c61e20d5eba67d02bca6793267c16e2063a21bbcba5099134c57a54bdaa83f300eb4f3d8a1750c38f28833bcdaaa24921049f7fa91a499afccc2e410200dcb019c0a5ecc3ec8d3ca84192b57d18491ba143a51e68966355694b9118459e71316e026cb7b2b104350db9c929cf7d9f511e32bb68179ee83774cf00c61070d0ce247afd5c0d8dd81d9387bee9fabfeed000039545f5696404b31247a050d2fc77b2e2ebaaf1b6c74303bffd84b4fbc103c4906b2a851950057998f7f219a2982100d45187de8254fca43cbf036faf9771b362c29a33a2e746f2cd8f3096149e55e0153953d6e600cb3cfaa55e87db29d537c9508d1b4c832a2c4a0de55598b2710940d082b8c9fa2ae6a552ccfa13de351b511088c90096999a66550aabee6f7f276937fa25a656c2d9704edbaa4e493e40bd8ef8846005b5e685e196836fd0e96cbdaa66387532a7afef1d0571becac40517f43c7fbfea3004ad61694ccb14e27e73739ccb8a7758bb15faed667136c9d3413b3f3d928721ce8ab40f121d052691962221027e91906be58ddbee52ee801b47ddd6543be09a62217245b6ff0f2435f7d747b7223afba34adc2fa895f146a837a9f98d2ce00d85b74b09c74cea033b9dc0003488a296158e78b42ea31b1b57d8ee76f845b0f3728763db929686384de1e6f529660f8b9b2e3c5ee00060755d9badfa9c1e82dee61ac23304b4a92c7251afbb3faef1a8baaf54899fb84c81db96704bf6639300eb60f260cef52629f7ff8dc78e8c6cca1620c2fce2fe50aa65fbebc40ffad6fbb86781856122743a715e124acfd9442a6d0e5e78d3709b3b569a784077e185b44cba252ff258a7452e86e3bf49010f7d634d072c3ced5087f1c7524944ae3fddf72df716984379f70d31f006715ad2d11aa9e1d1ea0a559898efb4edc6df7db80c05a8260f8722cbbab01624e15469b9a95178328f5f9ad3e1a39afdae50894d72ceb3f8508afc73027977402d5636a487292dfdafe71e80216b44d1628ed1479377a20065ed3a54820752f9aa488c78becaab3a7b8f1928f810a620c836dea7e02258fc06392c18b5d00b1800c9a1a1f625531e677bff51d7177abd6647f8912e173be3c77effcf124779efcbe3e9669bd75ac506582abd6b421d24fbc74d979c559c605a53fe3ff6f6eb87ec650ca0cf2f10b01c50398b0b8042604ac8a42b254c3c161b1494a761d64ba9fca91a8e954a0e277928cf82da90908896607185a1b55a09e14e369554db2f4641a8942db80d61c9022732b6a304f64f21cdf245118080b808462320b410ffdef9acd8ac6972701eed9b8a4648d7ede8f89093a65e078d0961cd09e8eeead15627725874797f8161727d869295483beb52a247050c05175b521e1d5170d06c857372378c40d826a40b8937d4dde84ce4120f1972030a3f171a16e606f1ea227886c3cee8861dd14492184c6be6f01dde3ebb5a24effcbe21feba36711053fd22a69d2dae58c9e7223d5f38308b69f9ac12530aa3f8e7d3fe533038506cb2390e511a9e44b994afc8fc3dc05e1298179060fc4b56081533867fc8d55e636d0870a0bc0b51daa22c7733dfa0c1e75c70b21f30bf4976db36a174774bb7d660aa11c588fe41d599b79b294cbf2349b877ed92fb766903ad82989df9e96827bed0b3c48b666d1dedcff1e168293f76603d6fa814c299e6571d063ec2edaff07b21ca4c44c47c219858de39e2439ad949a252f52ff06ef3206967c5e4ec11a45380a1c6446e96306e3dbee8756f3070ebf49bfb8c6c55084ec249305461d5dc708d2b63535d40e377f2482bfcc916d6210acd1980b53bfb9fc65ef4a14ae9846c6fe29ef67b4d75f245e1cf2f41bb8727459e6aa787407e86562a1b2b25641cf72882dd972e63f1f3b31b049a81f1d6967b6bc2d01b7346e70995ef87a55f181b8f96e58c1c8b6611b07a691380dc35316f1c2043319c6d99f0dabf6073b388d62ca12f335b2099f1f246bf8b5fcfa77cfaab2f4a6a42570588805c7153ecb9e2adf64e509d7cf3a08a4ff441830ceac0c836bb66ba1df0cd9d48f3f885b7b17d16fe9e06124631c0c78a2b4ec30d03ec15413b4c689f4757691775f172faa0cdbb37e22245d33a0648d22d35420af68d64adaf7a6ceef1ffa581a6c1c850869f4a5dbcfc532b39d637053983f18ed26b1d584d5cda44744719fe83e6ceefce07690da5058ee03ef63c9b89a60c2d47bf305387010d62bc7b035c1b44c5a15c3b65056535877d5d28325469fe6d2f1516c9952d3c4dc904735256836040f4a2063309145c38ff10773f1d371ec9bd0f554c17eaaeae70f9c5fae6139e0102e54dd4cb63633c11df5b53dcf2b054b38dd44bf17f04d4798ad4a7da70debf78f66b30acf96733f79832b2429dff816bde4cfe112958ce4ced810ddf375281bcc51e44d1cc3680336d130d1636f79dadc84f102d59fd7a96841408725801921a8d84cd6220643cd419ce083078241ae8578616692c2523396591480b5a1d4f11b0e15e4c87efff61993aa801f601dbfeeb5d940414a43876b1e5873a727a2af4f1da4dcc9ad2ad9432fe3fb80e31b87943e6693809ab72cbd1db73261fa97f85a8d6ca98ac5e2e30dcb239f79246ea899327859f4130232272b8ff86c5c2b3acab603df0866580ed797f3417331acc78903e7675e1a7d1f8569544104c9dbbb1257d47fca9351e4a1fc09511684001c3b8b64cc248655815c006b1c220e97dc784deb700334c4b7612388222e50c130872431112a3e2912a2df9fc0ba2588007d50afd3c2449d459945d58fb3218b30c2141aa30caed70160b3433575b8feb5afc920abb74da1e6ff471e223a996e7fa73af5a9311cb71acc25941439fbb45e258715ae6fc9985280a67e627b9ee6ac2a7efd33fe7b464edbf7e21414a03a6388817f3b4b91d0d670e59afcc7a7f174414f303ea0c35b9f8f2349219cca1c8eb3c992872579b4865c3cf22e2e204c16e48522cc189d5e406ada77bb83efb8798e0e89057cdab0d56fe46af60f7c30b1ad960db90330884f663f89f7525e7874726d027dbabc58421a001a6f8a3efc5ced0c179982d2aa5951eb7aedc87645e86ff77c0f289d89a5c93807cb8960e6aef74dda7bc48c72bf0bb6292923f5bf6aa87825198c51305d9f4e701beb1434a8c2279b1021102224f2b91c4acb0be73dfaba2da6398ec10a3f586ccd2234c119b4ba32bf97d6292834cd23a52d234d31bcf8bb07cf907c8761ae9023477e6f858fdf8fb0c903c687d2cc77ba008bd4218309c75e6c59b456d4dc7c403838634b2792d2cedbdcc0903dbde7314093987a31835917c3bb4c3ce55c971a81c81fabc697d103ff32eacc378f4240b712811a4a862d9de3cc86fca04aece32020e727c832996b2f19ac95619c57b30b3557ea7b8197ad7f956e58dc4ecce90b875d1319d4ea24eefc3bcdd24cf04e0ebe5c65c42d2b0420012c187d671e0faaf08b36ea588d43012e107bdcd6ad0debdb2047b2fa9282d6615a3aacfdba5e0cc744a0b9558c40f68a45a6e078214d24e33af39db56fb152db390517f0586699d06199eba1ad5c892ccfa5c07fadbac9c743647d764dfd19b8525817b31027ccdeb357cfad7ac84a31b59cd978ca759616888c197fa3c2cd0ca155c9351173d573e493cce1d71c901fdd06c81d60e86c0b10b2c2fdf9816caa893cae9225a97a90bde037242541419f754e0a61f615369894ea9d74172d6c1faeac6fdc852b2f961a89a0206f39616ec9cf19c0da85d7e0b9d7c9e315cb6f328fa4f7c821ee0294931a96c1bbff5476017bfc57d8f67dd7ccdf62751a15828bc5622cee9061d9c2b1661950b070bfe766b8a0a96fc435261ffd91aa69e32244fd6e3c7f64f0453d0401393259d852253daf5672affd1e4ca8dcdd69bca9790b3c164061e957e88ae1821edf10c97b68dbe48b61b08b40c3e661d3a5d438e96e5f7cc011882c79d844db7c1085adfac8a4dfa3e27dea76c2983096fbc25f0f3d15a89ee5038da638e6687b71f75612eaf8693bd9043813ae929f9d9819562968b0b9914f0f7a148f3b29106cf64b285a4ff532b24d39700a62c36b155f08a0a07de71296e493ce363f71f263829c688ae4ba9bb9fbbaecb9c8a25e1209f02e700dfdb07f310b391fba531eceeed2acc4c146a8d397108b8058044b8f1960b5bfa911a717c01c3b9e34028fa3166bbf1eccebe3def3fa7d47a02d3dce471b03474c5561412236521358561e3cddd0bc912e4d8240dcc8f7bee56bfab38e61d043ce626a736e327a8efa2f5c62032a176a86d960643c1d372ef02397e730631387074d08ec5cf1ff5a86650d65c3ad21270f9ebab900b9e55240db39ae26df656dd91701653470f6c59af84c06bf08c50ee8688cd27f5b177bd34792c2ccb46245ff7b8b2ad9966d356512d115651b66c9ca89b3194a87b6925158199005ecafbaf3931163b192d6e607c8af534d64306cd551b6164033263fe660be99c97b872a13a41ca37ae4258a14a617a11979c097dabcddee949169dce656da90f9be561781f73a6bbf1370971e2eb1c4ebde5bed156f9b97adfa7119e8a89cfd4d44c2a790c620024a91f191040de2e5ae800d0794010432db813e085300da4c98c4a7cb1d4e23cf296697e6446413b7bfcf8dcc731feb4a0a1cdcfb229dd6269b874b6f56173b37e0fd172389def6372e2c07dfafdcdee72d89c010dce90d4559714c56137fd450bb763d15e06c9e0203f3c5a918742bfc5becccd1253c909edc42ffc943545849bb15502b1202de69a70cc272e9868662ffd11daefa12dc4769bf1f2e13f39160dfcccd3ff230eb8d48eb200039fc1b22dc116e8732901f2d92baabbdbfb2197c3125503189a1eca2bace5be6d1f9c43d6ca303b7333cafa420f2ffadb032f50c7603e5ee469d5df6f1ff208c20a6adca6501af37dbf0f353e2c5ac01ef30afc2991d1a0cb5a1789dc89922c333e401da07503938279ee363c3900f2b4900e41bc1277a4a5f8da9fac86d0186652048ea041711ec6d61db69775d2438eefb89546d6571b963c69b10b7367d985b26588417d9c87cd6b9debea4d2baaebfda7beb8f39ad638da8094f86e992c0ecffdce4d50a4026979ab6476c92e12a0c876233f8e860a3776b1831a03f4cc5233aeefeb3a67422366ce65636769698d1a5d7241e4760cd52be5fd550eafc83034fc366343b3e37ee45df3e9991921165b0d4309910553f3be7840c63b888f576fa98284a592efc97ad92e4da35cc4f5548e8184ecff18d51db08dc0dd267be2e586f39d3cde70b1a8d017ce32fbc3930664703f22f73635598358cfe5a687e28aa224cc8724671152380c78fd6e4496bba23cb2a21bb26458f2a77c1921c7ccd465fc11d6fa52e421edda8506cbc464813881a3e3119fca89df22f6cfb9157b4317ca1b0bc67e2b47c5901ca7832f35eef5b38fdda89e333b85ba99ec7de8e2d86f12c5646dc5ad4e40464f2d7672e86a3f1e270fa762be3b28074e6801bd0a922d9ad69f224da2dbba4e0c329f053d3635e20f11175b6a7be9df763f92f07f1336b566eaf1157a87b62397782b5de4463a3d0d2e7020d172a2b787c8c02242c7211122f64a1b1102ea50103232b324e6ad31b2e44bad8fc0000000000000000000000000000000000000000000000000000000000050b13171d20282e83010000"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

func TestRecipientNormal(t *testing.T) {
	_, addr := defaultTestKey()

	tx, err := decodeTx(common.Hex2Bytes("b91c6602f91c62010380018261a89855f129a54149f8bfa08fe8d1159f78368af3de97647630830a825544c0b90a206c5c0256b7e67cb7e89b75395082c19cf08a31bdb0cddaa0dbf9099951f1eaba6b78effac950c20e2f10a07e53303e56ca0228685effffd57eb45677935753560cc2301fcf56c73a80684609704b96a50bb25921492b1fd20ee2dc796d4a9f0c6d1b21875c28081e722470236636ab762f8f7b3451f1c5d1865cd6bc75f9e063a93921f4c263413956931d4e4b951bf0c0915f130f32e9334efdb6df5e761a981e0be8708c07d4948643f85862adecad1008ddd0fd166e7933230d8683944959d99f22b61c59542e90caa92c43a1dabda2259029fa798d2aa4226af07ebf1de625603d173833064141bafeb367f2a5df2c177f229dacc119c5a94649a897a01289d4e0d4ace80868153c96fcdb03b4f3c8aa8fdd6b8ab74366322454e400fd2301e30912f6dccaae2647bba0f4b2e893c50f24ac81fb2b9f2fd6ccb8f4e6e1438054dc0284650ba99320654140da53bc57b927bdea089557661056290d826c547483839f8ab77467d959ea0a4bdcbd955b96e27e1d775ce35550f5dfcd8c4347609b75f8fc9746ceecd2da06f36803988a9bf902ccb27c1602333cdb9ff2e4409a7993fc5b54d5d57d1de56564e0885f1d71ee7144df744b0960f753d973d832cc1b7b761282a366abc3a42866b26b8c84518fa05d6a152f017e9bcb466575a470db29f5d7451ff3ae88ff706e9b71e2da68b4eafb82cda58b7ca208685e4c4caeab1ba4a79622e85c08826effe2224f2f16bde95b6a7cccde9b469e9b991e4ea8fc3f1eb54a8fa719af71d321d7b893e3751173f9ef2c48200695f1e29b17597dd5450dd43b3a04042c38f2c602c88ffa4e3e96f1611a43ff6c6734b63f685a9818c9354b900c2d2474afae0728e69e0ba93a9d8c782011fb51e7c6728fb940fef69701a9b32e8527c0a47f8a70f896f5700219215e78cd776ef5079fb6ed9caf20f93c50e20a6e3e7bff8c9b7bbd800e1e59139a3ab3aa5d4018dcbc7095b0d017b77185cc5400693992b1ce633b8d0406b3ba97573108cff5a897b06992bd6385ab5f3537f20d607788d4f0f956103506a0337295915fbe02851b9fcf32e8013a9b433c3250f072571b148436c898e6e78bed671c37fc467491254f68debe627b114c5cffeb1935312fe5abeb4ed22771a35f4aae9b64399908d4be447566e4bddb5ebf2b3837a9b99a7dc59cadba535a77814a43000464cb35a2998688fb2ad2eb66ed367807c9d92e9d776ad2895fdaf12d37cd8c61ff46d027d9adfc0316ec5f3b52f80af2614b18f1d7bdbbda4dc35ba5363d960399042efc1a1fd41f860ed1422ee84e73dc12f1f2eb895d59660c11b1edb72509e5b2212716b055fe52e5a58c3e9b5d22c6d9dc4ca2a1f205d65bc4f9f24f44c72cf42d9b8b91c65858332bb24324b47877aafa523f880cd4724ff990cd2b079105071df7ee90692f43ce23e71a8bc0745984e652b65e6013385e81d44563491f546b0064e9cfb7643da4393cf6b3a7afd4fec232016700c65a8531a88e213a9ab5546255528fc0ac9992c46c1f2ac3192adc32423dbe052dbe33e46aa6d369717c74da5a8eea8e8e281b1f37c8352d2879e4ca9b8e3e0ea3454744ba8bec5434cd3ade1c783085a3dfeaeb90703cca8d0b9fcd9ea063b2ae88ded6b84f9a1498252483a5c7583756631da66bf81ec480478204731baff7f2f2e8cd6ee8a2a76d1dbaed7a8254eb002cc18fd65b57f7982176242e546fda668458378e52eb25ccf149ca097381a878643a34c811d4391474d5d09f5d4317815fc02095cda18372d72ed60d35b70c6554bb91dd8ea4a948ffbeb1bbb130b1109cf4d1702070bb8c9572674fc1df859d9aac67a541af321aa518b1d0de130621141f6be4ffc9226afff782cd2ebb9b1f87162cb32c7df2ee2931a55dff603dda6f81bc1858ab48044c1e6c45c3740c8386d8c357ec0d9dc0ff9ddd7f38ebab0e9f6e6d0f23c944a059109d332e35d2b786fde3df1975b761cef5d52df5f837315c1218d9003ea916f3dd98f926eec8781dd92e726752095e2388cac1a3c8b41da90af4942f8e734105d3b8cba0f310dd38267d2d53e0aa00780efcebbc267ff9bebc980918bdd1b4f42655d0671de9b762ea98ec55fd5d07bb102aeec85903f6653f47ee4951213170bbdcf35a276e0fc4a10df4077b14e9c326890fc502dd5422fc601ad76d45e2ac2f9cdcf1802b4fd2f54af989b0c4087feb032dda3fac5b292af1fbe53013acf162d0a7cfd908d7be37d78904161a04e6f67a63350936ba9d0a94b9400777a3cf2e5c78fc9ea4d0b2de1bd80bed2f0b2201d78a45f37099f912da6698f6bc1eb5a98bf11bd7f3a06fe95a7211a52410913d5ba04d1f80ae24fc499d380980b324ea617def1fd7b90e15df83cd0233f9cbf603aeb41f8f2f3d796596edbca55d385e2620542ecf4fddcee771a69642e7c7bbd2b20acf2774f3e9b0e9adae01ddb5925350b9977ea53071b0db3306dd6dd7c667225d540595013398205381501203bb05bf7c44738936014e1ad5214e2f26059d11f986bdc234f9da8860548e1ede1ca0bf87a010b503f2346610137bc7df2295bb5de4d38c5dc73a7738294232cae9effb82e5a7f012f7b15e223925fb9a1b998545efc28b76a2d9361d545d603cbcc019f70ff073d16c5e2727f123d95eb42339ebac494ce7f28555aea065e6161486fde260a02024f15af6592892934e9fab09025c0ac606e0491e965b58d1dcf60058059e4726728e037a698cf74bf2f2f0f4f9bec51cbc035f32eb3e617cb892af5406e6f3ee74e177a1bb07d1d3b5f80cba842d6d2e7eeb5b2ad7bedb0d9f5e6255033b1bc187064b19b72a2eb926961be1441426200ce27893e30cc217e0a8a9c33fdc22e7c94b49ef094443fca1e528035ec04c83f187686d22862ffcd9edf223d2d1d86da65a597f9f1b784395541bb5d960c1bbc34d0c15404182b3746f875b06bd5f4d41ccb58ed03de6df566cb85595b21ce3bd7062a515bc365c925965e8800263731618f70258a731e41eb45a7d8e19cf18ee8ff0eabb0dd7c89e0f6aacce42dfeee14704d53105f81b627fdb6399c23d330d8ed169e4a76c3d4158016afafdade3b725bfbfcdd8457eef2a8f8566908da236e3a0b35486e0cc979bdcef27329d354624f346a308470d813b28d204b7fab4613243b37ccf92b347390d1da0bf902cd4803a9aa54fd46fc85ff63cae54ce45785aff19cf6b1cf7ada4f3fdaeafc8989e7c9221efc0d5048c6b873bb9951729f92aa097393726a1e904460eb6344a7f4c8d680c0bafdd2f80ac559d82b4970153b87fb7724ac9c92a8dd35c8ebaff1f3d99202d8456d3ed4fa8728f1d4901c883e7cb26dbf804871e4170b6e274c1514d5a64b3c8f4bc70ee41bd0bbc44c1ae016e9bcdf6e71158d37623cf40a64cdf9fb4c230ca8680cd74d49de200acb00ea38117dd8cb246d421b29c355de0cee7b0de003e3c55821a067d8b0b5f8b01a4e5634e48131578a89870e059fb4794d45ba0713179a545a2ffa43d92f178dcf7c6f05c80aca3a6b16419f8d9f6d118caaa5a59535b3211b8ab651de3444ff1205c38df1f7d6b6bf96e04a7d2141a248e0b39619f3da001c437ea752d9c1605d4c11950ffeef401dd3608f368b4e365e9b912133539f14a36e5edeaec2c99da0691cc282ee263d5e90ab4cfaf4b05e9474e69cb7b25d7a4f8637d696d3b12cbccf765b4aedefb949542f1abcbfdfb651284f7f3651f1b9960d7b04092caec6c69efc8ad83fc9b00c9d18d4d117c45b76a0a700f32cd68cd78241517a0d0d334c962df3e13f31f4299a677fe41c8dc384d9d29d11184b7d5c0ad24b9301406642b2034cce1ab1dbefe8c082cd072d1328d05336e6a72df2627647f32785d2da66cf927d01b01d4cc1f52fc1ac24022689e73bb9d4138e7b26913ad84d8102869dfc06defce696ba420a5135f7f5454f04924e6b9e25d1a2f9f97be41a35988bdef5a2c8f1d56111370e00a7f9378f3fcea00075178edfcfba5d40384795acb11f21bb4a944e1358d82b636048c55e491090894e5a8b89b110175ec07c0732e5780098cc8319ab75033f8aa4baf5784f29d8821240e4ef915dba1a2f157a433f29acfb82781fa13bdad0a7ad4be67399f1c083333f5e1b3c3d89fcf38478e745494646ed6e54f8d1cfa331028219fa08f1c9f132ebe18900f8aa7b877b01aa06002adde361afb33d10e5d0000187e2df825eb81618642a8ac01dad889cfac612873053e65bc1b99aacbfa435f894f248071e301fb6f727fcd9fceaf1ca4fe82e6d92535e056365d0f67940f0af51c63f364d3e156640393d64388baf57cbcb08f9b9f0282abafc79e5e1ca71562c6140d0c5b4f948302188f2fa50141f2294e9c7c49fa92d35069623bdae2f8dd923f49afad63add4e84558734522fdd429551343ff0d266423ddd108c6800049ce4d5dfdbfe292c61e20d5eba67d02bca6793267c16e2063a21bbcba5099134c57a54bdaa83f300eb4f3d8a1750c38f28833bcdaaa24921049f7fa91a499afccc2e410200dcb019c0a5ecc3ec8d3ca84192b57d18491ba143a51e68966355694b9118459e71316e026cb7b2b104350db9c929cf7d9f511e32bb68179ee83774cf00c61070d0ce247afd5c0d8dd81d9387bee9fabfeed000039545f5696404b31247a050d2fc77b2e2ebaaf1b6c74303bffd84b4fbc103c4906b2a851950057998f7f219a2982100d45187de8254fca43cbf036faf9771b362c29a33a2e746f2cd8f3096149e55e0153953d6e600cb3cfaa55e87db29d537c9508d1b4c832a2c4a0de55598b2710940d082b8c9fa2ae6a552ccfa13de351b511088c90096999a66550aabee6f7f276937fa25a656c2d9704edbaa4e493e40bd8ef8846005b5e685e196836fd0e96cbdaa66387532a7afef1d0571becac40517f43c7fbfea3004ad61694ccb14e27e73739ccb8a7758bb15faed667136c9d3413b3f3d928721ce8ab40f121d052691962221027e91906be58ddbee52ee801b47ddd6543be09a62217245b6ff0f2435f7d747b7223afba34adc2fa895f146a837a9f98d2ce00d85b74b09c74cea033b9dc0003488a296158e78b42ea31b1b57d8ee76f845b0f3728763db929686384de1e6f529660f8b9b2e3c5ee00060755d9badfa9c1e82dee61ac23304b4a92c7251afbb3faef1a8baaf54899fb84c81db96704bf6639300eb60f260cef52629f7ff8dc78e8c6cca1620c2fce2fe50aa65fbebc40ffad6fbb86781856122743a715e124acfd9442a6d0e5e78d3709b3b569a784077e185b44cba252ff258a7452e86e3bf49010f7d634d072c3ced5087f1c7524944ae3fddf72df716984379f70d31f006715ad2d11aa9e1d1ea0a559898efb4edc6df7db80c05a8260f8722cbbab01624e15469b9a95178328f5f9ad3e1a39afdae50894d72ceb3f8508afc73027977402d5636a487292dfdafe71e80216b44d1628ed1479377a20065ed3a54820752f9aa488c78becaab3a7b8f1928f810a620c836dea7e02258fc06392c18b5d00b1800c9a1a1f625531e677bff51d7177abd6647f8912e173be3c77effcf124779efcbe3e9669bd75ac506582abd6b421d24fbc74d979c559c605a53fe3ff6f6eb87ec650ca0cf2f10b01c50398b0b8042604ac8a42b254c3c161b1494a761d64ba9fca91a8e954a0e277928cf82da90908896607185a1b55a09e14e369554db2f4641a8942db80d61c9022732b6a304f64f21cdf245118080b808462320b410ffdef9acd8ac6972701eed9b8a4648d7ede8f89093a65e078d0961cd09e8eeead15627725874797f8161727d869295483beb52a247050c05175b521e1d5170d06c857372378c40d826a40b8937d4dde84ce4120f1972030a3f171a16e606f1ea227886c3cee8861dd14492184c6be6f01dde3ebb5a24effcbe21feba36711053fd22a69d2dae58c9e7223d5f38308b69f9ac12530aa3f8e7d3fe533038506cb2390e511a9e44b994afc8fc3dc05e1298179060fc4b56081533867fc8d55e636d0870a0bc0b51daa22c7733dfa0c1e75c70b21f30bf4976db36a174774bb7d660aa11c588fe41d599b79b294cbf2349b877ed92fb766903ad82989df9e96827bed0b3c48b666d1dedcff1e168293f76603d6fa814c299e6571d063ec2edaff07b21ca4c44c47c219858de39e2439ad949a252f52ff06ef3206967c5e4ec11a45380a1c6446e96306e3dbee8756f3070ebf49bfb8c6c55084ec249305461d5dc708d2b63535d40e377f2482bfcc916d6210acd1980b53bfb9fc65ef4a14ae9846c6fe29ef67b4d75f245e1cf2f41bb8727459e6aa787407e86562a1b2b25641cf72882dd972e63f1f3b31b049a81f1d6967b6bc2d01b7346e70995ef87a55f181b8f96e58c1c8b6611b07a691380dc35316f1c2043319c6d99f0dabf6073b388d62ca12f335b2099f1f246bf8b5fcfa77cfaab2f4a6a42570588805c7153ecb9e2adf64e509d7cf3a08a4ff441830ceac0c836bb66ba1df0cd9d48f3f885b7b17d16fe9e06124631c0c78a2b4ec30d03ec15413b4c689f4757691775f172faa0cdbb37e22245d33a0648d22d35420af68d64adaf7a6ceef1ffa581a6c1c850869f4a5dbcfc532b39d637053983f18ed26b1d584d5cda44744719fe83e6ceefce07690da5058ee03ef63c9b89a60c2d47bf305387010d62bc7b035c1b44c5a15c3b65056535877d5d28325469fe6d2f1516c9952d3c4dc904735256836040f4a2063309145c38ff10773f1d371ec9bd0f554c17eaaeae70f9c5fae6139e0102e54dd4cb63633c11df5b53dcf2b054b38dd44bf17f04d4798ad4a7da70debf78f66b30acf96733f79832b2429dff816bde4cfe112958ce4ced810ddf375281bcc51e44d1cc3680336d130d1636f79dadc84f102d59fd7a96841408725801921a8d84cd6220643cd419ce083078241ae8578616692c2523396591480b5a1d4f11b0e15e4c87efff61993aa801f601dbfeeb5d940414a43876b1e5873a727a2af4f1da4dcc9ad2ad9432fe3fb80e31b87943e6693809ab72cbd1db73261fa97f85a8d6ca98ac5e2e30dcb239f79246ea899327859f4130232272b8ff86c5c2b3acab603df0866580ed797f3417331acc78903e7675e1a7d1f8569544104c9dbbb1257d47fca9351e4a1fc09511684001c3b8b64cc248655815c006b1c220e97dc784deb700334c4b7612388222e50c130872431112a3e2912a2df9fc0ba2588007d50afd3c2449d459945d58fb3218b30c2141aa30caed70160b3433575b8feb5afc920abb74da1e6ff471e223a996e7fa73af5a9311cb71acc25941439fbb45e258715ae6fc9985280a67e627b9ee6ac2a7efd33fe7b464edbf7e21414a03a6388817f3b4b91d0d670e59afcc7a7f174414f303ea0c35b9f8f2349219cca1c8eb3c992872579b4865c3cf22e2e204c16e48522cc189d5e406ada77bb83efb8798e0e89057cdab0d56fe46af60f7c30b1ad960db90330884f663f89f7525e7874726d027dbabc58421a001a6f8a3efc5ced0c179982d2aa5951eb7aedc87645e86ff77c0f289d89a5c93807cb8960e6aef74dda7bc48c72bf0bb6292923f5bf6aa87825198c51305d9f4e701beb1434a8c2279b1021102224f2b91c4acb0be73dfaba2da6398ec10a3f586ccd2234c119b4ba32bf97d6292834cd23a52d234d31bcf8bb07cf907c8761ae9023477e6f858fdf8fb0c903c687d2cc77ba008bd4218309c75e6c59b456d4dc7c403838634b2792d2cedbdcc0903dbde7314093987a31835917c3bb4c3ce55c971a81c81fabc697d103ff32eacc378f4240b712811a4a862d9de3cc86fca04aece32020e727c832996b2f19ac95619c57b30b3557ea7b8197ad7f956e58dc4ecce90b875d1319d4ea24eefc3bcdd24cf04e0ebe5c65c42d2b0420012c187d671e0faaf08b36ea588d43012e107bdcd6ad0debdb2047b2fa9282d6615a3aacfdba5e0cc744a0b9558c40f68a45a6e078214d24e33af39db56fb152db390517f0586699d06199eba1ad5c892ccfa5c07fadbac9c743647d764dfd19b8525817b31027ccdeb357cfad7ac84a31b59cd978ca759616888c197fa3c2cd0ca155c9351173d573e493cce1d71c901fdd06c81d60e86c0b10b2c2fdf9816caa893cae9225a97a90bde037242541419f754e0a61f615369894ea9d74172d6c1faeac6fdc852b2f961a89a0206f39616ec9cf19c0da85d7e0b9d7c9e315cb6f328fa4f7c821ee0294931a96c1bbff5476017bfc57d8f67dd7ccdf62751a15828bc5622cee9061d9c2b1661950b070bfe766b8a0a96fc435261ffd91aa69e32244fd6e3c7f64f0453d0401393259d852253daf5672affd1e4ca8dcdd69bca9790b3c164061e957e88ae1821edf10c97b68dbe48b61b08b40c3e661d3a5d438e96e5f7cc011882c79d844db7c1085adfac8a4dfa3e27dea76c2983096fbc25f0f3d15a89ee5038da638e6687b71f75612eaf8693bd9043813ae929f9d9819562968b0b9914f0f7a148f3b29106cf64b285a4ff532b24d39700a62c36b155f08a0a07de71296e493ce363f71f263829c688ae4ba9bb9fbbaecb9c8a25e1209f02e700dfdb07f310b391fba531eceeed2acc4c146a8d397108b8058044b8f1960b5bfa911a717c01c3b9e34028fa3166bbf1eccebe3def3fa7d47a02d3dce471b03474c5561412236521358561e3cddd0bc912e4d8240dcc8f7bee56bfab38e61d043ce626a736e327a8efa2f5c62032a176a86d960643c1d372ef02397e730631387074d08ec5cf1ff5a86650d65c3ad21270f9ebab900b9e55240db39ae26df656dd91701653470f6c59af84c06bf08c50ee8688cd27f5b177bd34792c2ccb46245ff7b8b2ad9966d356512d115651b66c9ca89b3194a87b6925158199005ecafbaf3931163b192d6e607c8af534d64306cd551b6164033263fe660be99c97b872a13a41ca37ae4258a14a617a11979c097dabcddee949169dce656da90f9be561781f73a6bbf1370971e2eb1c4ebde5bed156f9b97adfa7119e8a89cfd4d44c2a790c620024a91f191040de2e5ae800d0794010432db813e085300da4c98c4a7cb1d4e23cf296697e6446413b7bfcf8dcc731feb4a0a1cdcfb229dd6269b874b6f56173b37e0fd172389def6372e2c07dfafdcdee72d89c010dce90d4559714c56137fd450bb763d15e06c9e0203f3c5a918742bfc5becccd1253c909edc42ffc943545849bb15502b1202de69a70cc272e9868662ffd11daefa12dc4769bf1f2e13f39160dfcccd3ff230eb8d48eb200039fc1b22dc116e8732901f2d92baabbdbfb2197c3125503189a1eca2bace5be6d1f9c43d6ca303b7333cafa420f2ffadb032f50c7603e5ee469d5df6f1ff208c20a6adca6501af37dbf0f353e2c5ac01ef30afc2991d1a0cb5a1789dc89922c333e401da07503938279ee363c3900f2b4900e41bc1277a4a5f8da9fac86d0186652048ea041711ec6d61db69775d2438eefb89546d6571b963c69b10b7367d985b26588417d9c87cd6b9debea4d2baaebfda7beb8f39ad638da8094f86e992c0ecffdce4d50a4026979ab6476c92e12a0c876233f8e860a3776b1831a03f4cc5233aeefeb3a67422366ce65636769698d1a5d7241e4760cd52be5fd550eafc83034fc366343b3e37ee45df3e9991921165b0d4309910553f3be7840c63b888f576fa98284a592efc97ad92e4da35cc4f5548e8184ecff18d51db08dc0dd267be2e586f39d3cde70b1a8d017ce32fbc3930664703f22f73635598358cfe5a687e28aa224cc8724671152380c78fd6e4496bba23cb2a21bb26458f2a77c1921c7ccd465fc11d6fa52e421edda8506cbc464813881a3e3119fca89df22f6cfb9157b4317ca1b0bc67e2b47c5901ca7832f35eef5b38fdda89e333b85ba99ec7de8e2d86f12c5646dc5ad4e40464f2d7672e86a3f1e270fa762be3b28074e6801bd0a922d9ad69f224da2dbba4e0c329f053d3635e20f11175b6a7be9df763f92f07f1336b566eaf1157a87b62397782b5de4463a3d0d2e7020d172a2b787c8c02242c7211122f64a1b1102ea50103232b324e6ad31b2e44bad8fc0000000000000000000000000000000000000000000000000000000000050b13171d20282e83010000"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

// TestTransactionCoding tests serializing/de-serializing to/from rlp and JSON.
func TestTransactionCoding(t *testing.T) {
	key, err := pqcrypto.GenerateWalletKey()
	if err != nil {
		t.Fatalf("could not generate key: %v", err)
	}
	var (
		signer       = NewShanghaiSigner(common.Big1)
		addr, _      = common.NewAddressFromString("Q0000000000000000000000000000000000000001")
		recipient, _ = common.NewAddressFromString("Q095e7baea6a6c7c4c2dfeb977efac326af552d87")
		accesses     = AccessList{{Address: addr, StorageKeys: []common.Hash{{0}}}}
	)
	for i := uint64(0); i < 500; i++ {
		var txdata TxData
		switch i % 5 {
		case 0:
			// Dynamic fee tx.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				To:        &recipient,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 1:
			// Dynamic fee tx contract creation.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 2:
			// Tx with non-zero access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				To:         &recipient,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
				Data:       []byte("abcdef"),
			}
		case 3:
			// Tx with empty access list.
			txdata = &DynamicFeeTx{
				ChainID:   big.NewInt(1),
				Nonce:     i,
				To:        &recipient,
				Gas:       123457,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 4:
			// Contract creation with access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
			}
		}
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("could not sign transaction: %v", err)
		}
		// RLP
		parsedTx, err := encodeDecodeBinary(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}

		// JSON
		parsedTx, err = encodeDecodeJSON(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}
	}
}

func encodeDecodeJSON(tx *Transaction) (*Transaction, error) {
	data, err := json.Marshal(tx)
	if err != nil {
		return nil, fmt.Errorf("json encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := json.Unmarshal(data, &parsedTx); err != nil {
		return nil, fmt.Errorf("json decoding failed: %v", err)
	}
	return parsedTx, nil
}

func encodeDecodeBinary(tx *Transaction) (*Transaction, error) {
	data, err := tx.MarshalBinary()
	if err != nil {
		return nil, fmt.Errorf("rlp encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := parsedTx.UnmarshalBinary(data); err != nil {
		return nil, fmt.Errorf("rlp decoding failed: %v", err)
	}
	return parsedTx, nil
}

func assertEqual(orig *Transaction, cpy *Transaction) error {
	if want, got := orig.Hash(), cpy.Hash(); want != got {
		return fmt.Errorf("parsed tx differs from original tx, want %v, got %v", want, got)
	}
	if want, got := orig.ChainId(), cpy.ChainId(); want.Cmp(got) != 0 {
		return fmt.Errorf("invalid chain id, want %d, got %d", want, got)
	}
	if orig.AccessList() != nil {
		if !reflect.DeepEqual(orig.AccessList(), cpy.AccessList()) {
			return fmt.Errorf("access list wrong!")
		}
	}
	return nil
}

func TestTransactionSizes(t *testing.T) {
	signer := NewShanghaiSigner(big.NewInt(123))
	key, _ := pqcrypto.HexToWallet("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
	to, _ := common.NewAddressFromString("Q0000000000000000000000000000000000000001")
	for i, txdata := range []TxData{
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			GasFeeCap: big.NewInt(500),
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			AccessList: AccessList{
				AccessTuple{
					Address:     to,
					StorageKeys: []common.Hash{common.HexToHash("0x01")},
				}},
		},
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			GasTipCap: big.NewInt(500),
			GasFeeCap: big.NewInt(500),
		},
	} {
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("test %d: %v", i, err)
		}
		bin, _ := tx.MarshalBinary()

		// Check initial calc
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: size wrong, have %d want %d", i, have, want)
		}
		// Check cached version too
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: (cached) size wrong, have %d want %d", i, have, want)
		}
		// Check unmarshalled version too
		utx := new(Transaction)
		if err := utx.UnmarshalBinary(bin); err != nil {
			t.Fatalf("test %d: failed to unmarshal tx: %v", i, err)
		}
		if have, want := int(utx.Size()), len(bin); have != want {
			t.Errorf("test %d: (unmarshalled) size wrong, have %d want %d", i, have, want)
		}
	}
}
