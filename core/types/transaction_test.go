// Copyright 2014 The go-ethereum Authors
// This file is part of the go-ethereum library.
//
// The go-ethereum library is free software: you can redistribute it and/or modify
// it under the terms of the GNU Lesser General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// The go-ethereum library is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU Lesser General Public License for more details.
//
// You should have received a copy of the GNU Lesser General Public License
// along with the go-ethereum library. If not, see <http://www.gnu.org/licenses/>.

package types

import (
	"bytes"
	"encoding/json"
	"errors"
	"fmt"
	"math/big"
	"reflect"
	"testing"

	walletmldsa87 "github.com/theQRL/go-qrllib/wallet/ml_dsa_87"
	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/crypto/pqcrypto"
	"github.com/theQRL/go-zond/rlp"
)

// The values in those tests are from the Transaction Tests
// at github.com/ethereum/tests.
var (
	testAddr, _ = common.NewAddressFromString("Qb94f5374fce5edbc8e2a8697c15331677e6ebf0b")

	emptyEip2718Tx = NewTx(&DynamicFeeTx{
		ChainID:   big.NewInt(1),
		Nonce:     3,
		To:        &testAddr,
		Value:     big.NewInt(10),
		Gas:       25000,
		GasFeeCap: big.NewInt(1),
		GasTipCap: big.NewInt(0),
		Data:      common.FromHex("5544"),
	})

	signedEip2718Tx, _ = emptyEip2718Tx.WithSignaturePublicKeyAndDescriptor(
		NewShanghaiSigner(big.NewInt(1)),
		common.Hex2Bytes("1b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd0000000000000000000000000000000000000000000000000000000409111821242930"),
		common.Hex2Bytes("98d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3"),
		walletmldsa87.NewMLDSA87Descriptor().ToDescriptor().ToBytes(),
	)
)

func TestDecodeEmptyTypedTx(t *testing.T) {
	input := []byte{0x80}
	var tx Transaction
	err := rlp.DecodeBytes(input, &tx)
	if err != errShortTypedTx {
		t.Fatal("wrong error:", err)
	}
}

func TestEIP2718TransactionSigHash(t *testing.T) {
	s := NewShanghaiSigner(big.NewInt(1))
	if s.Hash(emptyEip2718Tx) != common.HexToHash("cf171c2aadabcb1e36975d0949d3b831188b555b7764342bf7b1b47238c428e4") {
		t.Errorf("empty EIP-2718 transaction hash mismatch, got %x", s.Hash(emptyEip2718Tx))
	}
	if s.Hash(signedEip2718Tx) != common.HexToHash("cf171c2aadabcb1e36975d0949d3b831188b555b7764342bf7b1b47238c428e4") {
		t.Errorf("signed EIP-2718 transaction hash mismatch, got %x", s.Hash(signedEip2718Tx))
	}
}

// This test checks signature operations on access list transactions.
func TestEIP2930Signer(t *testing.T) {
	var (
		key, _  = pqcrypto.HexToWallet("010000b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
		keyAddr = common.Address(key.GetAddress())
		signer1 = NewShanghaiSigner(big.NewInt(1))
		signer2 = NewShanghaiSigner(big.NewInt(2))
		tx0     = NewTx(&DynamicFeeTx{Nonce: 1})
		tx1     = NewTx(&DynamicFeeTx{ChainID: big.NewInt(1), Nonce: 1})
		tx2, _  = SignNewTx(key, signer2, &DynamicFeeTx{ChainID: big.NewInt(2), Nonce: 1})
		to, _   = common.NewAddressFromString("Qcccccccccccccccccccccccccccccccccccccccc")
		tx3, _  = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:      common.Hex2Bytes("00"),
			Value:     big.NewInt(0),
			ChainID:   big.NewInt(1),
			Nonce:     1,
			Gas:       4000000,
			GasFeeCap: big.NewInt(2000),
			GasTipCap: big.NewInt(10),
			To:        &to,
			AccessList: []AccessTuple{
				{
					Address: to,
					StorageKeys: []common.Hash{
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000000"),
						common.HexToHash("0000000000000000000000000000000000000000000000000000000000000001"),
					},
				},
			},
		})
		to2, _ = common.NewAddressFromString("Qc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2")
		tx4, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       common.Hex2Bytes("095ea7b30000000000000000000000001111111254eeb25477b68fb85ed929f73a960582ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"),
			Value:      big.NewInt(0),
			ChainID:    big.NewInt(1),
			Nonce:      47,
			Gas:        53319,
			GasFeeCap:  big.NewInt(14358031378),
			GasTipCap:  big.NewInt(576312105),
			To:         &to2,
			AccessList: []AccessTuple{},
		})
		to3, _ = common.NewAddressFromString("Q535b918f3724001fd6fb52fcc6cbc220592990a3")
		tx5, _ = SignNewTx(key, signer1, &DynamicFeeTx{
			Data:       []byte{},
			Value:      big.NewInt(73360267083380739),
			ChainID:    big.NewInt(1),
			Nonce:      132949,
			Gas:        30000,
			GasFeeCap:  big.NewInt(14237787676),
			GasTipCap:  big.NewInt(0),
			To:         &to3,
			AccessList: []AccessTuple{},
		})
	)

	tests := []struct {
		tx             *Transaction
		signer         Signer
		wantSignerHash common.Hash
		wantSenderErr  error
		wantSignErr    error
		wantHash       common.Hash // after signing
	}{
		{
			tx:             tx0,
			signer:         signer1,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSenderErr:  ErrInvalidChainId,
			wantHash:       common.HexToHash("b7528638c6ed144ebaedc7132ba5be318a5bee800b3fec5849280a5710ca645c"),
		},
		// NOTE(rgeraldes24): not valid atm
		/*
			{
				tx:             tx1,
				signer:         signer1,
				wantSenderErr:  ErrInvalidSig,
				wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
				wantHash:       common.HexToHash("1ccd12d8bbdb96ea391af49a35ab641e219b2dd638dea375f2bc94dd290f2549"),
			},
		*/
		{
			// This checks what happens when trying to sign an unsigned tx for the wrong chain.
			tx:             tx1,
			signer:         signer2,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b0759fc55582f3e60ded82843dcc17733d8c65f543d2cf2613a47a5c6ac9fc48"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// This checks what happens when trying to re-sign a signed tx for the wrong chain.
			tx:             tx2,
			signer:         signer1,
			wantSenderErr:  ErrInvalidChainId,
			wantSignerHash: common.HexToHash("b6afee4d44e0392fb5d3204b350596d6677440bced7ebd998db73c9671527c57"),
			wantSignErr:    ErrInvalidChainId,
		},
		{
			// qrvmone example
			tx:             tx3,
			signer:         signer1,
			wantSignerHash: common.HexToHash("00c89f03a2c0fe998bcccb984e0a6ec7c1eeabc6f46657915a402a3247219d28"),
			wantHash:       common.HexToHash("1c8ca6842552a370f2db68b76645720d9a7fa3aee68f2fca3a0b511cf2745c03"),
		},
		{
			// qrvmone example
			tx:             tx4,
			signer:         signer1,
			wantSignerHash: common.HexToHash("840f004a0ca908700b48a591f09afb36132e0767109c0485ab94f1daf115d4a8"),
			wantHash:       common.HexToHash("57dfbbd7564bee7b92e98b4cef896cc324d68891add7425731df914b45ebf096"),
		},
		{
			// qrvmone example
			tx:             tx5,
			signer:         signer1,
			wantSignerHash: common.HexToHash("2004db20334ebe7941961d9abd937b952bb688f9a5d58b998b24a8179c8dac6f"),
			wantHash:       common.HexToHash("953bdc74c10db9370d4208e5306e21be4bb43b9c44fa7d25dd888ecb5227081d"),
		},
	}
	for i, test := range tests {
		sigHash := test.signer.Hash(test.tx)
		if sigHash != test.wantSignerHash {
			t.Errorf("test %d: wrong sig hash: got %x, want %x", i, sigHash, test.wantSignerHash)
		}
		sender, err := Sender(test.signer, test.tx)
		if !errors.Is(err, test.wantSenderErr) {
			t.Errorf("test %d: wrong Sender error %q", i, err)
		}
		if err == nil && sender != keyAddr {
			t.Errorf("test %d: wrong sender address %x", i, sender)
		}
		signedTx, err := SignTx(test.tx, test.signer, key)
		if !errors.Is(err, test.wantSignErr) {
			t.Fatalf("test %d: wrong SignTx error %q", i, err)
		}
		if signedTx != nil {
			if signedTx.Hash() != test.wantHash {
				t.Errorf("test %d: wrong tx hash after signing: got %x, want %x", i, signedTx.Hash(), test.wantHash)
			}
		}
	}
}

func TestEIP2718TransactionEncode(t *testing.T) {
	// RLP representation
	{
		have, err := rlp.EncodeToBytes(signedEip2718Tx)
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("b91c6202f91c5e010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a2098d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3b912131b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd000000000000000000000000000000000000000000000000000000040911182124293083010000")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
	// Binary representation
	{
		have, err := signedEip2718Tx.MarshalBinary()
		if err != nil {
			t.Fatalf("encode error: %v", err)
		}
		want := common.FromHex("02f91c5e010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a2098d7a5475db0f58d46759690779479d393d75159e67e62074c26f3d8aa7199b4614e2f8e5aa9807ba63dbcdaae0919c33305ad8b12edb51312b24934387a76c4e17bb7f8277b511a5f43be6adec021fb4f0509f06cb9289f1e46eb1c6c00cc36e6d89956c7d21c1b9f25a6d31a5cfe6cbbc2e592bf9e08152f397ce208ed614ec6cfd76ec6cebb81dfd84f797ad829d727c57cc5d49c0b32402ec96c66cbc56e3a293097aba2c7cde1894e76e0b1b79766cfa29d8244cf39543c0aab63eede3fa78ceda637777e016bc839b8871d571073afce5923d608adbcaeeb503972705e646d437918326297909664e0855795de4b5abda2eae59963e41118cf9e8cc036dd9f1d13834412b255743f07ec6e99390a734f370e6103c1228347925f9417afc59de00fd3ae32f0fed4fffafe4bc69359fe02ca0aca00d18bdd328de13c2f30cd42ee5ec0aeababe6898a0492e2d11aa2a57755a13d6c25b91ef274dcf037b33ea375dfe8d37ffe5d7e08725ac936374e90ea091b0857c4fb7f2a67a4e9f861363ae875da01ec1038cd5a1fc97b801360e52260ad966bc7d8748ef924a4833b91c33166aa7c3664a92f8e23d25efa482217fe9318de98cff1b8dd33ceab2d3e22254e485142759533d27b7cfec7a59e8f0b4cbf9114a0470ae854d4a5fc3637aa91f7bb681bf53476395aa36135bd62c689722042dd3c077eb8151c73182fd4c86e6d54e45962af6aebfcac99c3e7dfeb04229202a0b6a0c95255d533f937f14f226df7e82d20baeef71ab542901bd1cc68f9df817bf0fa2ca5b22c171bbeef7ea16b9ee428f8a5a8372d32d725a0f11be995563893b22a20a9b2271e73ae462399f0b878c1deb0beaa2db12aed7abd7216fcfc510930ac985032f4d98521a5df434d3921131b91b59cfa48a4cda6fdea2019e98714713ff8231f600c94439bbd42d7f15789d74f074ec0d943b439f8027b3051796f61a789f5ecf661200d88c91ae7f51b0cc6fd42978199297b425dd5e58bda64dfc23d55613951c9ac6deb19366b25abc8dd999fb697aa307854f9acbef6569862ce89801ad9d7e5dea48a8277489d8d4e54aaa5444a8cfd4ffcf66403393985055847cad809252a1650891fca7f45526c57f79fe77880c8cf0d184dc67d4b8892a18fd7417447434b947ed78ba0ae10cac9ba29d252849b50f1cf386fee4c8cf95fc9077d3618338188059c12d05442a412a2f02d83a4ca8870d4f26d831e11ca40b75be23b2e1c26de6845fc5c8d9296c26447cac05257b4240b47fbf5b9494b32606673f3fa032cf8562d0c4fa3e5a86889a1e5269fc4198205e98da20f611e4e2910db356bfc1cbeeb44ad3bdafd6863b0f90b2f30b1780e9efb14eecfd6150df16c2cc41e94e0941488c6e973f553ae8b356f8867b382b070dc0467caf59c4141f264596f760ed886e1a781e48b2329a3d1b6ffc2bb30afeedbf5844769af40df9dfbce64f4e8e783b02013bb60a0d11699e1afb800d5fe4ee93c66ce7f150f67cdcaaa81979671cf50419a2500a17a1a19036c1e448271a1a51d1ee61236d163de3e3aeae86e10bfcfb43f314711a3142a5ff165f1b4252545939feef12f5259297e570e83fce4e4e74a2fa3bcbcea971cef558960ca6afd073dec8b2024caa6c9945bc3531bd04489611c73d979307070bc898fbd3a15ff53190c0c268267a18a949449b61127f75d6ce03fec9f3e69bbe9cdeb77ceffafa59078b09c0b57007450649490c4b84a5964a4ec40cb4a9ed11af84b13825e716fa15f51eced4e02fd409d9c463ac6a861de41d0342b6055b6cb4e08c5be68b3cda46a2369b63655c43ca58395bfbe4ecebc8f4ed6d3c3a3f37c7abdfb8a3b56024114ceb0ba89c74a12896dcc1b8a6324878c9156481b7eb577ccf25f89175c8caec930c47d838a5b7b6e3d0ef0d2f33bacd42627dd7762554d3b0833780ca0dbd7f1d40032abd332cbb12ea440646acfeecf6ca269f9a974c99e93c30c8c271f95c209169cffcd3adc21daaeb5ed418f63220b6844a608161db7cff21aa5198a87b0393bf1a09e6d473c2df65f7a45d140962e8d31e0074aef19fb7021c9cd68d03277e2cfd67ca15f3ac4364d12c7d72afc054a291e08d342f3d2ae925f4132135cc4203beb23c950bf62e2fd80a12dcb60b2f863cc1faaeea0ec057bfe942aac13ed11f9437b4038c7c0613238cb1143cff36a85d2802f0567edd52f63f6a4f7dad8b0566fc428af7367d125ce92227bc63a734b03b58d62635304b914f5ae86bd5c248f3e31bb432e6ad5874395f7d5022a1921da294af113832f838bc3cd4b5491d74177cf5854e51faccbf93b8406a790129e7d691328ec5f7f5386f2111646752ff32c3c579fb38f92855dfd6bcf02187938b9ddea3328462c06b843779b1ffbdd99f8f46a3b3998931ca745b5d10b7e2508c62f89245823005d7d6a887605023004f1f5a59f1639f174a3546670eed283e5abdb9ff5b6bbdcf51e25a4389bc546072c8f495cffcf70741cf77d35e2fd9be834290f43541d3a059d6778e8e2d6629e9a000ef94d108d597426dfb373306b55f8ef33c6f8b228cfd56ec217c11e76437fea7b70d1b30a3892c41f10149d6c7b59562e5ef940c31e59ff22385ff53543b46cbd1ab3fb411f40f61fb6151d9be01ce4d31f67d1993fb8308784ee5fb3d5e37ab99f63f02c1389ad6c1e7b84e289e6fbd7a537082b849f49db9c0eddbde658ff3d5120e15886552ea3714eee67b000b1ca75a144a9a76f922c49414c9dea653816fb857959360fa09b6c9eb722578eded0c7e8031ceec743d81e4f743edb2383c6bff6ed5e4d33ceb36dc94825433e384666da0eece5bffeaf48f7bc89ed4984206c5124eda4d6a79e500ae136057bad0a833aa61de79fe36fe35e8fea8b998631bf236708df50d3760e26d5089dd2b7d61ca733e3bb7aacb403b2b6e12c94c7dade82e51c32ae03dc420958d475b38fd2f70152af1fa5d13709a9ce0f096968f8d918b76334de3a84a21fd6e72bca523dd2a06fec5984e0ca01d70bad34921987aa5168022bcc9896ba38ebf12e2ab941b9b9e2e5f4ccebca21080a4ddcc4968fa484ad2b000e69e055dcc72378710b2a314f8155aceb705645cfea6ef7497079f969bd450b59d016ad87d9d1e9eac6316f42df74a9de80d6c46ac84d1eb19702ed4946ac655366dcc30dea85d3293d9221469102d207b7d823450c1f551be0f431a7ad9f80a41c36497446c48891cef58dfd2e0c3304be0e57ca699752595e76209f92a888eeb9fd24733cc09939395b8f62e5e2e70669ec20ed937ebaff66fff159030c5af738d6f9585063f8d4c1cbdc415010fc0e73c9aee89fe85d6dcd68f5ed1a248f6507c1577742a33c583a4e83cccc8c252715f8291e41b01b0150ebef6c787bc706b0abe7b57bbfb2053f87d9a012927a70a9f3e7707878e0899d0064ac8ba6e472dbdac3a86dff21ca21b06220bee22b4a40096b345bdbe008b433605a1a230f791f48329a9ace5a1a8c9187af5e77c8c9d6988658ba8fc0c0050b01aa9376250f99554ffe3a2e1009eeb6f1da36bc24c14ff12e09ba80e89fe06801eca0c4d40aa24bd1088dedcf7a0484ec9e186979ac2a89fe2f34dfa3ba0740b46dfa521580e3b912131b0d096ec8664b065b37fac1576bcbdee3606103634d274d2a9c5fa482f820b7fd23b74d54a81a1ca898b592890f2b23c82c7c0971f8124aede44067b438d74d4c7ad5e2ab9ef5f40a57b41a36748e4dbf9ee5682f6f92777cfee6eac6e2089d699325704bd6eaf6911904888ad1998c5b1082c45035a12939bbdaf0559e02adc368b47f5b1e96070936c2885ac8ad21cf89a135f8a2bd43a4c4b4081f76739efe6ef3c22567afa8c4b2470840c38f2f14cf1ce9f9a8fcdd3756c1c26d806f74db271aecdb4bac7e562601633e538f2f07c70bf164efe9ca8e5449939b0d1e4e175c4c1a084b14694ba6b3d3f671a422996cf069b1cc2a5c2be069c5e398548223cc4b07e332c770e0b54dc1a82f71c4e38e6754f59101c423bdce55141884c97a7bd933df4318d4be8949d694e81779030e99c9008b0fe530bb3c2cbf67243063177c69e4aedb62256f6d1494734adda5666f5722daea3f8f19e3d3d79a0a27f7c40b328ae9acaa19d9fc233523600a309e6c6267b68c2011f6d88d4fa68b9e52de0a61c85280367fb1c803bf2aff38dffc932c122b71f5e147a3b1b346213ba5c1390b4fd577522c30ca324eb08341d42428448af7680a9763e60a053b12f3400d465e69710c832d8799fbece5efeb88fb550455e2442ac44cc35511b462442c63c8a7e261265e8809f0e78e67a9cc44713fe3cd0121a68b44d8dfa8e82c0a02c1078225530f2f82f1238b538d3a191ce15e15876aec7ffe8d4d94047ee80e0fd867159b34590132bbbcdf7eb95978b40f3595e7daf2dc03f12c6a93923ef62133988b12d6773cde2f4727b06850a60f9f1d1a2a1e952a020bea22383588f8ea85bad48349faf4d8c96ff4add50b6836b9fcb3a1a2d2e36a38221799b0887b07f5c59e92ca9bf9e1847721c81363a4d9559cdfbf8b707f643b33bf6dfcfca1309e75176f10401a50bc7f6b273e5d6b7c255348d318947736219e8dd9639ac3bb43cb413ae956a8bc24911787bc3c2b64b75fc1eeab9b56b35c0e9ce5b1944df2658bb73e52bcd5672aea740facc87fc7e5e76ce80a0f4a3999b61bcaf2b5d559360af9538d0ff1261e305e69b495646d23190ba151a4e8b3e685573942a2d45533efd41bc188356cc2a443885528bf3df1d609499758bfdc6aafa6de4815129ac13f2b1468e0f57f4231eda9e594739cf55235d1f9f5c4ae9b9fbc8ae2568f932ba82370f866e1b5b79be6e5792f49fe2e6aba0a430b47eb5494134a7e451980606e36aae7bf94fd717a04fba5e99c35573035096a967c0035b0cc78ee7d1eb65b84753d91c3447a8f9e7a9c50c12553140cc2856341ece3c8fd63e501f18fe335be353b2428d85fcfe4b0fb054237399372e81f69f50a8d88ba16491b6011b26b077e0efc8054eefef073afd2d25f8b797a2f94074bf430f4754d074e862bdfc2198f6a9872b7cd383d18ffa671d31404999d8d011da2879c31791cfd7fa0e4db28a8ee8fd86b9698528b77617a45a10db84c0efb5f382677f28293232f95eba3c810b554668452bf7086ec81609de5a9d7c9be997a96f2e2188bc939ca30cd981efd6c71a8a133d9f8338287bc415d74a986ae91bcfef2ba17169d85d7bb3974c2b2aeea357d9f6273a863fc40448345c2101a41c88da978073aa544d51db3957bcf5d24dbd6997a379a3780ce5b99d6c55c1d1eb8b6f5c52e3ab1c4daa169c2f1d17cc28b623c5655d99cdc115f476043ebdbf8b329ab447242c75dd41e967aabcb6965c0ae4406da0dae7cee5a7171c0bfc701d232cb7400f766ab5fab7ff08452366a5d6b2409f098be8e93e90ef58b4aff465031776136eeb7aa2d3fe89469f32bae32bcac580021e22dd6048c03cd854fef652562039db95a63caa25c7fb25c483fe814c4995315f8fb6d52dcb98af58e15adee9e881f53de491a76dd0117bbacb6840bf7cfdb8e006762dbf182362398b7434c2649f634c34724c90b6cad949eb80c9217aed0c8647ff511be45c966e3cbdacf61b0d6dff2221584b35ed0d80b766f60386e232e8751465573ef8a05182945ccef5e0ee4cdbc85a3d25ed791c14806e2a77d17e3463fb54ed9839cfbfdfba469b9cca8685cff0fc1b2936f47de26e9cfd094682a653d7d01dc8fa80ecfd74de8b299525baebe7c03b78213a24cd654647c21d59cc31f8d119f382a543280a2825a28f29963ffad413386ce9ba47697694dd561d0b71d080ee0b88feb15b3184f2fb9c319781076a9aa9af1b0cb6f67b4f1a681eb492c8fdd3aebe54140b9bd44bc061630ced09dd1c6213827dfb8a3204b4dff30bf40ddefa938c9a38bea0755181592cd90941ef7c3986c9309425da5cdbb1f07e8f2ba2253ea5bd44767dd19b3761a8f0e597e78a257b5e7e57479525ceee086271f04a962a5f879661b04c66be8d0d627faebbd0752f273975511a5ccb973ae3ea66a69c96ef5ef85d6e4aed65be56803eb512ddff66b997418950e959db8d7f174697c736693a25c3f5a02eb15d5e8b0a6e5499070809e43d2ec21972db9d3afd898732a8f41a9f1eab9939cb3e515cd971acb0ca79a93d8a66e30ae305cd1bc3af869df4f5446336d0e8a1393afbe2ec16a19dfa90f6ab5885d0d9d18a6f249ea125f6a1f630045d4a752bdd4f81c5057465956c17677380d4ebdf0cf83fd8eda69a2e437cae4021c0b3b61ec0efb56a84195b6bf580d0dd90d6f0d159e150cf92527681f1555487895dd13e50c8e51a9a66390984524fa7b4acd5eb258d5a183f3a7a988fd52e2373d16e5c0889324d01873b04541844314e0e3d14276a460bed6439cc777a6db3f4c61203953c72bee5109ebe75a66d285431be6978ae6ef94d3fd29b0e4f79970fe7b905699f6f2cc0c1a5f1c58bc7b4c966ac42d9b975cb41d17a99e425a8a72e1db265c48dafc13b575e85f4a2c5f55cf8d671652f270379dd8d1c6f68dcb3273c79d0e0238ada06c02af57cfb10ce45f4a46600df45cb67eb6439f60287ecba514cfcf2696158cb51ddc1b406a853627e46f70caa8efd9350d7b9ebdcc2da6aff754768d1b7282b8db22c615633c4df89503d5078acdd5ae49fb466b62f071b2a616b238524e5d373539cb0b15b3c9750d708a2026644d33f7976f784c6235195da7d2aa231bf2ee9e7e195b07f0e828d348c5cb4f9f99e0a0c9f709efa18c80de53ecd8121c5bbea9d02ac39aa5019d5ef20d6e0c3b3152cbeacae299069fed282a17bd74293279bf05e495f9e733b18796055330467ddececee51e81d8d09df39c5242a2a163cdfc77235b69cfce7293c3d293c3b57011b7388c157566f283f1e41fccec1102879e4252cd7e79db27c7873414735b5b157446b430ac2befd50ccd04217e11114abb131819df80c667e028c4c780dbb4be8aeb70f0e4073b4fc01a946a8c778a2d800d68698ef8f59459db6d142d062fc1d00211a115fa75d85aaf09657d54be4114532eb466670f41bf44c04a310b89ebf3dd67948a7e2f4a157d2ff6f4bb6f3b07512ee43ff7275680f497d31cc1b4a2789aeec6b7eb2abb72da7e4e3bd4ef4a635686e74adc122b801c632e31bb2701da7aa03fc5e84315617c4309f76765a3ba85e8c84afa0b3dbb4071edbc9d136bf3933b3777cd1ba63315ffa2c59a9b65ef718652010daa30cdd1a691195d14d22a20b9f23b272b5a8feee5b7f367189ddbb4a0cf12c730225a0638a4940e20c60d7d7c4d5d67f50e803a01395c038e6ba676855a6aa7626aa5d2a8257de76064074d22c09a13e7673f6adeb2b2f71347a19962235012dc229346e3f48f86ceb91df111d54eda3c142b1bce264bbb8accf5d6877c7c06b5d0da1978c43f526d41c628a6e7801340dd4497f137e3c2c9e0e252120d9f555c8c3cffee1297622d55b74b76e3ebfc1c4829f0973b25c7e2bd5e324621ec1f4a48673d4b947809aab725ef3912b106df13318893923e8881e6eefeb10198719ffd17a90c2a7dd5f8e16fe5a05da60c9e4a47f435b565b81d86e1fadc677fd11335ad1a045631ca2395e1a80b092e0fda6d39114f95c082268833ae053c9672bc358039baf19678ddde95873d26900675cb8884fd4ecac37e9ecc12d34b7dd94e7607f043c03807b2d2be0b82e3d93a9c83a689e50ebe3d4a361e53d39b0c2a88e238b7f199246a9463926d0d5df32de1e4a985972a359e6216284ac5bb6419463d3a35b6aef9e57f5f3fb3c3eff6c5ed1386c21c76eab03d8a1c651c38e6738ef601c690b20dc35625e3a91767ac1aa117fd7284ada8930d35dd58dd04fb3c5fb171a5395c29536d9ea7c4b3e5642fc1d0b6f7fb083217da8c517577fe857ec64499a5309cdf8cd910e05ad8688f09bce2d4d52683f7d1302b68fcac0ee0e138ad2629b3fc84825630cfe70f9e9ff643b67b714d2b46194fcbed5bdeb3d7e5bcb033eaf45758805c7dca0b704cdd96e6eafc73cf346c1d719e61798cd2f071f24f6fe4f421b5cdd59287d0279d5b739584b0ec0cde6871046b2bf2ce24204f173a432237d04aad2010d8df134e81cb426ddc1ce11c4f02ecdd0a82b802cb58740fa78fd841d31c67043ad118b5c16545f6908fe30a54fcee888076537a87c468b95eadb4f84a5a24e8e254e4e1083b7769b2b30c9b4ae81c45091e291cb43766b70787b0ac6c8fa3e489fb3a6cfc64fac84af800ec0d454b16c68b18e143741ecc5cfbbb433a025bd2789533760d921b74c707e639f2c2ffadfce96a649e44c2de9b7eb8f9ff677bba43da11889370f3c0f8ed8ae7c7cb702c21345c90cae31da484f362c14573bb91f4cd5f2d55ffb95b6ba83a248ff9a7e05e1d2797bf030663ed07363a9860bbfe83dfaf3969e9ef9c4167381c2d3089c66e1afeb5c9bf25c7ff33ea8ef4a3aaa0eabd58ce3d33ca9688e0b07e5ce478622a963ed65d56a6d390b58588781d180ecca88a5b1c5d3ac10a4e7ff23e435d863f40eab531d0a5a0d71c4243965c08c2684aaeaebcbd8827cbd21c13c7f94a5d6a67af6182fdac3ebf67633791dda87130916de84cb113881f26531ed67dbb4615d3cd5f90cc9395ea4276b720038eb89077a66b73478cbe328eb3eda9529b7bdb3083310b050ca00070112d5bc7e0fdb3ae09e5a5861027976c32f0e3db07f30166c6f23f089a7aa2ce6784f0e539908fe06fb956cec2c0429750815edb6e7f5399a88b3b2d6de28b7537650dbca9ff47cce3779436b3d1ca103c88fc98d04284f002ecc85872f40e16cb0ccd870f775756d5a52781afeb174f9bc4ef77257fc75ada5402b08068fae4010f391dc944157e103c6a112ca6ff8341038a1bb717ff1c200de1c8446f1e7bded0c7b992e8428bf344d278a47ee3879793f594a51758b7471b1e96dc11ba8d6e8785a5f626cad8a5d83a1681768760ba3b963c3cd1988a466a5cbe8bf68bec4a88ec4fb689cfd041d397a5e3cba9c88723fb02f4e14efc1d968a2064dc318ed9526f0675c410def79941d5fdd42c0c377ddb36cec060172257e132f9680315db91ac0b5d3ad4f86d6eaea21d8a6e2a4f5d0d8f363fd8ba8faf4e453435f955f500cbcc35947e777cb2d7686db90d01d1da793e5aabb4b14e648cea4deef029e262947c55b902d40fb7bfc2ef4506c18829038ad7a034886bcc453588a98e09e6053e10f8d6da84ec59bd92477233bf9429444c5bbfeea8282451cc120f342cf642f24b6ee40c2d316865b900db71dc0e64655b54b9153bb304da9d67e5008d583c58992fb5f1cf230d2e96656a95752bbc43d78c1c9f1d88b25758bc1c30353b3b94d2ad209e441dba5099bedc2f57e0cfaecf751924ff774fd6d7a47a2ea956b7a4fcc0f302760df54c9228ebc26bab8bfc83ab46ae498b4e418af5647983a9cb20e05e29cabd5df98c83fbe7fa17da6f9c50101935980aa97b197433c7044a2d23f30f45687e078f8f6915e46eae7c1d6379e2732d1f87bccbb5e857d630083ca1612e94326c8723c5c8d341255b319489c1d4cf5f625d7e48bb922845316c9be99da86ad48fc968ebe0de82dad4cf32213f8491f68ff1e6df21b85afa86c08477d0bd46806288b5871124e99d6d6f7e9a5e3d90ce221257c39405d373b39289b95f212c620d801055525afd2d4735787f408672aa48864a7139d30966da8cd5db2a79f1e48d0b02c7fa784da8ff482ced97a9930643ef895d5446dd1862f4d0d460a4b22db478650280cbb2d010144225f32eb593df00d58f1387c39d8d24bf8b13b115c71aa2f343eb983899ff75460b7cdd3b39fd4be68b9fffee11f56cba5ffefcbbe22b92118936a42bfd3a6434b11f20dc328e13387d6679a2cf07155ef4c1b92c0b42bbc9178ce26dbe8af191f20e6430d74d66686508038b0000977bc27d8211b4897507fbeecf4c72b6c5ecbebb8d00473bc0d7e55083a7abdf2b426a717a8ad9f50010224464b0f8284b648cafccd2e1f49bb3f40a24aee6ea2644515f84b1fd000000000000000000000000000000000000000000000000000000040911182124293083010000")
		if !bytes.Equal(have, want) {
			t.Errorf("encoded RLP mismatch, got %x", have)
		}
	}
}

func decodeTx(data []byte) (*Transaction, error) {
	var tx Transaction
	t, err := &tx, rlp.Decode(bytes.NewReader(data), &tx)
	return t, err
}

func defaultTestKey() (*walletmldsa87.Wallet, common.Address) {
	key, _ := pqcrypto.HexToWallet("a7b1a3005d9e110009c48d45deb43f0a0e31846ed2c5aaefb6d4238040ad4c08794ffe65585c13eb6948c2faf6db90c2")
	addr := key.GetAddress()
	return key, addr
}

func TestRecipientEmpty(t *testing.T) {
	_, addr := defaultTestKey()
	tx, err := decodeTx(common.Hex2Bytes("b91c4e02f91c4a010380018261a8800a825544c0b90a206c5c0256b7e67cb7e89b75395082c19cf08a31bdb0cddaa0dbf9099951f1eaba6b78effac950c20e2f10a07e53303e56ca0228685effffd57eb45677935753560cc2301fcf56c73a80684609704b96a50bb25921492b1fd20ee2dc796d4a9f0c6d1b21875c28081e722470236636ab762f8f7b3451f1c5d1865cd6bc75f9e063a93921f4c263413956931d4e4b951bf0c0915f130f32e9334efdb6df5e761a981e0be8708c07d4948643f85862adecad1008ddd0fd166e7933230d8683944959d99f22b61c59542e90caa92c43a1dabda2259029fa798d2aa4226af07ebf1de625603d173833064141bafeb367f2a5df2c177f229dacc119c5a94649a897a01289d4e0d4ace80868153c96fcdb03b4f3c8aa8fdd6b8ab74366322454e400fd2301e30912f6dccaae2647bba0f4b2e893c50f24ac81fb2b9f2fd6ccb8f4e6e1438054dc0284650ba99320654140da53bc57b927bdea089557661056290d826c547483839f8ab77467d959ea0a4bdcbd955b96e27e1d775ce35550f5dfcd8c4347609b75f8fc9746ceecd2da06f36803988a9bf902ccb27c1602333cdb9ff2e4409a7993fc5b54d5d57d1de56564e0885f1d71ee7144df744b0960f753d973d832cc1b7b761282a366abc3a42866b26b8c84518fa05d6a152f017e9bcb466575a470db29f5d7451ff3ae88ff706e9b71e2da68b4eafb82cda58b7ca208685e4c4caeab1ba4a79622e85c08826effe2224f2f16bde95b6a7cccde9b469e9b991e4ea8fc3f1eb54a8fa719af71d321d7b893e3751173f9ef2c48200695f1e29b17597dd5450dd43b3a04042c38f2c602c88ffa4e3e96f1611a43ff6c6734b63f685a9818c9354b900c2d2474afae0728e69e0ba93a9d8c782011fb51e7c6728fb940fef69701a9b32e8527c0a47f8a70f896f5700219215e78cd776ef5079fb6ed9caf20f93c50e20a6e3e7bff8c9b7bbd800e1e59139a3ab3aa5d4018dcbc7095b0d017b77185cc5400693992b1ce633b8d0406b3ba97573108cff5a897b06992bd6385ab5f3537f20d607788d4f0f956103506a0337295915fbe02851b9fcf32e8013a9b433c3250f072571b148436c898e6e78bed671c37fc467491254f68debe627b114c5cffeb1935312fe5abeb4ed22771a35f4aae9b64399908d4be447566e4bddb5ebf2b3837a9b99a7dc59cadba535a77814a43000464cb35a2998688fb2ad2eb66ed367807c9d92e9d776ad2895fdaf12d37cd8c61ff46d027d9adfc0316ec5f3b52f80af2614b18f1d7bdbbda4dc35ba5363d960399042efc1a1fd41f860ed1422ee84e73dc12f1f2eb895d59660c11b1edb72509e5b2212716b055fe52e5a58c3e9b5d22c6d9dc4ca2a1f205d65bc4f9f24f44c72cf42d9b8b91c65858332bb24324b47877aafa523f880cd4724ff990cd2b079105071df7ee90692f43ce23e71a8bc0745984e652b65e6013385e81d44563491f546b0064e9cfb7643da4393cf6b3a7afd4fec232016700c65a8531a88e213a9ab5546255528fc0ac9992c46c1f2ac3192adc32423dbe052dbe33e46aa6d369717c74da5a8eea8e8e281b1f37c8352d2879e4ca9b8e3e0ea3454744ba8bec5434cd3ade1c783085a3dfeaeb90703cca8d0b9fcd9ea063b2ae88ded6b84f9a1498252483a5c7583756631da66bf81ec480478204731baff7f2f2e8cd6ee8a2a76d1dbaed7a8254eb002cc18fd65b57f7982176242e546fda668458378e52eb25ccf149ca097381a878643a34c811d4391474d5d09f5d4317815fc02095cda18372d72ed60d35b70c6554bb91dd8ea4a948ffbeb1bbb130b1109cf4d1702070bb8c9572674fc1df859d9aac67a541af321aa518b1d0de130621141f6be4ffc9226afff782cd2ebb9b1f87162cb32c7df2ee2931a55dff603dda6f81bc1858ab48044c1e6c45c3740c8386d8c357ec0d9dc0ff9ddd7f38ebab0e9f6e6d0f23c944a059109d332e35d2b786fde3df1975b761cef5d52df5f837315c1218d9003ea916f3dd98f926eec8781dd92e726752095e2388cac1a3c8b41da90af4942f8e734105d3b8cba0f310dd38267d2d53e0aa00780efcebbc267ff9bebc980918bdd1b4f42655d0671de9b762ea98ec55fd5d07bb102aeec85903f6653f47ee4951213170bbdcf35a276e0fc4a10df4077b14e9c326890fc502dd5422fc601ad76d45e2ac2f9cdcf1802b4fd2f54af989b0c4087feb032dda3fac5b292af1fbe53013acf162d0a7cfd908d7be37d78904161a04e6f67a63350936ba9d0a94b9400777a3cf2e5c78fc9ea4d0b2de1bd80bed2f0b2201d78a45f37099f912da6698f6bc1eb5a98bf11bd7f3a06fe95a7211a52410913d5ba04d1f80ae24fc499d380980b324ea617def1fd7b90e15df83cd0233f9cbf603aeb41f8f2f3d796596edbca55d385e2620542ecf4fddcee771a69642e7c7bbd2b20acf2774f3e9b0e9adae01ddb5925350b9977ea53071b0db3306dd6dd7c667225d540595013398205381501203bb05bf7c44738936014e1ad5214e2f26059d11f986bdc234f9da8860548e1ede1ca0bf87a010b503f2346610137bc7df2295bb5de4d38c5dc73a7738294232cae9effb82e5a7f012f7b15e223925fb9a1b998545efc28b76a2d9361d545d603cbcc019f70ff073d16c5e2727f123d95eb42339ebac494ce7f28555aea065e6161486fde260a02024f15af6592892934e9fab09025c0ac606e0491e965b58d1dcf60058059e4726728e037a698cf74bf2f2f0f4f9bec51cbc035f32eb3e617cb892af5406e6f3ee74e177a1bb07d1d3b5f80cba842d6d2e7eeb5b2ad7bedb0d9f5e6255033b1bc187064b19b72a2eb926961be1441426200ce27893e30cc217e0a8a9c33fdc22e7c94b49ef094443fca1e528035ec04c83f187686d22862ffcd9edf223d2d1d86da65a597f9f1b784395541bb5d960c1bbc34d0c15404182b3746f875b06bd5f4d41ccb58ed03de6df566cb85595b21ce3bd7062a515bc365c925965e8800263731618f70258a731e41eb45a7d8e19cf18ee8ff0eabb0dd7c89e0f6aacce42dfeee14704d53105f81b627fdb6399c23d330d8ed169e4a76c3d4158016afafdade3b725bfbfcdd8457eef2a8f8566908da236e3a0b35486e0cc979bdcef27329d354624f346a308470d813b28d204b7fab4613243b37ccf92b347390d1da0bf902cd4803a9aa54fd46fc85ff63cae54ce45785aff19cf6b1cf7ada4f3fdaeafc8989e7c9221efc0d5048c6b873bb9951729f92aa097393726a1e904460eb6344a7f4c8d680c0bafdd2f80ac559d82b4970153b87fb7724ac9c92a8dd35c8ebaff1f3d99202d8456d3ed4fa8728f1d4901c883e7cb26dbf804871e4170b6e274c1514d5a64b3c8f4bc70ee41bd0bbc44c1ae016e9bcdf6e71158d37623cf40a64cdf9fb4c230ca8680cd74d49de200acb00ea38117dd8cb246d421b29c355de0cee7b0de003e3c55821a067d8b0b5f8b01a4e5634e48131578a89870e059fb4794d45ba0713179a545a2ffa43d92f178dcf7c6f05c80aca3a6b16419f8d9f6d118caaa5a59535b3211b8ab651de3444ff1205c38df1f7d6b6bf96e04a7d2141a248e0b39619f3da001c437ea752d9c1605d4c11950ffeef401dd3608f368b4e365e9b91213ea2a6a68c90cb477835338429ee7c21da2c6d91848f1c16cf7dd979a7b7aad437100cd412224fc8c638f53d57f6e814e2596018b6e78050bb9c4070316629affa5fd6cb168158f00c7f1c3795fdeeeb04d2344c74b7ab092cf177aa089f4cae1c16c216d0795463bec2e9b0c05202694df08e610cff54d20744016043baef87dacb72a3add4534966edf00adb5f35293bc10804503aad6cf0e9baee0fc9477b732cfa4688a43799fce94660916aa16638d660ce510dac8646acc4c88a1d6e6bded623a88a9d1f4e6f73fc14cf525a26fbc7e9db1a53e942396e3098c29f15f4e935ad1564e28a6de9b4d90610b2f1c667da817b7ab7e17565c0a5769c5c7636c07aa5ec0738d3e38b4355f84560abf04438fbc91978e680576ffbb4fe1ff5c2c0d30636821bf51d6048b33a3cbc56d6c17eb8d23830d484e748417cd60c03d19eec79fd6e3e6d829402e1f148208e30c7c3531ca7fa8c734353272f24eeea97b3cf9f60a765cc153a86257927661cf6a2fc52b234f7e38cba029615ded91332ec73149d84fb5f5e9b369a02c9e4ea01ce6822843a33aa5b29f63d2eb08715a637ea1b222aad6b22fc260bc5298daf27b4a1521980593fe487f7a79bf95e8921cbd3edb61c08d0054c66f1f933af18f3569d734e73ff5b7346691b87c2ee8575351907dabb19d3945e1e6ca934a31d2f5a685185c248bbf1f086ac1f0472b53b72bc1d6f34e5622655c95ba776028f8d712aaf5e80f0dfdfe154633ef7ae1a2de5a57cbd24169c0c2d996d5ac858e4c1201df844ca8126234b311b9774b70449d26ab0b20662b6013498e8ddf95b1aec9a0efcb8ee1a42db4e336410b1c6e3069bf48075a14d80802c081d771f8380a7a629d066fffb622b495a9f2ae3b2d8ef25111076933439396d3d5ab4d309f114bb2957e8423a4cf59fa462a43583637cd4e90532840abeebc6439e09106c3a45d2bf5e1e336acbd2f1dd54bf855aef172ade9e16784d8c2e1e840fc3dffbf7c956afe128e5c2d23c8618b67f45e38d697023ca693b64a826c6e4c4180849483fbc3cf35a54549ff3657707c45faa640e5d0477e0ed3e1b74ce1b7b34ffe7779ab58ee8495e52cdfb4b25de5e92552dd54a6aba6a9ec2330bf6b92087e6e27b6dfbd6ac128f71cbb7ae3bfd5ba78ea00826a4939d893cc9aa9bc5a8ef327d4c164fe712f0f915e3448a7b634ae83f59f53c16f6c29a901c680c211d8d606bf49530e49327ac2489e74589825c739cfaca6d42e56ec457841dd1c5266538bdd6359e0d834bf6173d09a61404db914a8dc0e8a5f052031e8a3cec18260779166f5ac9babf9a3be6dafd29bbfa2c7604b4ef097fb63fbcd381822bd8d1073151396e70a9c4f3544d3d2b6e8cefebaa203c9506f960d68e1d3b58c32fb7d9cb6d23830e72af135035447e60205996a153230195988bcc730c5fc79f8bd8da7fc468fbd85f972eb0a42943fddbf06824a21342971eeb856e1c5f76ac08ded783756d03ba0cfe054ac17456711ef360d9a974536357e441e07fe808504caae2ce8741a831ae230209a5b1a4e09c3e360bf6ed73ca23756ebe084628e3c9330505979e43b47c8d01bd9477cde958d5b7d4e7a9d6ce81bec0cda4bfe7369dc47648d10ea8ae772120265cbef4281644c2f7471ad8b19aec8aca2b2fbc28a696b8f8d777dac52c832363aa1aa0e87295f687048bae498320648170fd61919a5ee701ae997562d118b442af0c96d711534a72e8ae3f03b2939c5250141cd1a1b758c84d96c73d93c9c32b2414548a89dfb7cdfecac80b513c71ecd56810cbf087f7e4bf5ed99a400f6ce47e32123ecb698e96b855104387ee216dd25bd9eaeb6cac44b0c32d9b4f43a1c628c855ec3ba3d8f01222639ecdb15966b6e5043e349956922c2918042a695bf5703caf79f3a2238b7aa617853eeb3eebf9c80210d000e3bac1c62f7c2a416c06f51f584b270132c52992ec1289bd21639aa553e8c58d3d18f3a8edc0d9926a367f9a1faf1dcdb7130a3466c1ec0de279be626e0e838a5aabf258df2424c6c208b50ed55b77dc0a1eb3698b2f0fe07833be14fcc0767b62073172af4337d77d1e162cfc6eb6fd470ca95dea70d0376d3e719ac7c036e9c347b78e55bc8765b9e3aa45128d7895d6f7f1c5813ff7969722d70f6088660f6eb01380a4723d75042ea02456656a870248911811ed733fa2875bab6a0446eabf3c651609024335fe2305d40969fd8ffa9eb00152605e01d94b0c6121c95e9f96f52010f0ee39d2c6e071c6734ecab279413ade64eee0566456951621764b228c51adaa05b18ab623a1195fd312d962ea888d0c26bff27219c74a4d338f652180c7e15663d46ba6c1ca83dd5ab8db4eaf66d98faa530d6ddae0dfdb8f64c32458cd1b3bb358a3ba783e8c58d558671d96541c3d9bbaf789ce72dd8e1aa2d68b381c0ec15e3f878fc25dfd4081611f29f115246b8d9b17e71509cfc5316dccd064b2b97a244f617ff39789b3bbc1a1baa57c06b3464b114547b485d3f1c8952008cb10ae9e72d569cf5829c0589a6364bea325921726b440868ab3486883cc18c63a34ca7bfa7222a60ef84015e079aa749b9da55a8b8c614c2ed154e4d673480ff6e9eea9531a93d54522d3e770f864de10d6d7b3a124397770d089e23b753055b1430db8b2cb0cb9c32b053c69f896ff6fa0f26d000b8895beb43bee10c53e55e13fe382958186db38bb073d188b4bdeb388015cac4ba889935e7686cbd5d13eaee2965a92c62b029671b023e71dd6c9df8d94ab0bb4953fd4bd680aceeabb7a7d7b46530de6a8d3a0e949c662c70f285b68f934d9dca20bb13ffb54102a5ca21cd8d5ee691062e3d46bd89f84dd2a9f01eae9d0c35fb7ccd0155617ba33ae7389fd72e3da23677d082c57da0feb92bab0746ce7f8119c0fa17c35e794ade164f57dc4d84530c4e273d3bde167ad0552578e1f6f134d11f0ce6e082dca992235245bad791bf34ecc936d8036866e1fe3a17df311f3af97233219694c74a319e332af8c2ffe3aaadadfcadcbb431b2b2c46cc83612cfa56395468d71d67938c1dce87bfe396e3b2dbbd127c231910354770bea380b20f309b96035348e9dbd51e8e9f2f00164a8a1aaebff1cb6fd7f740ade67a2e064723c81a7b8802d6257299342cb181e319f6d97e7e7fdded7711e3074603d62367d9ddc4093f931ca9a2ea252afe92dae112e6749cbab5fdf3c470163435ba287a8146ca8576f2efe1d6f2f570038607db7d794f5e2c34744b49bf33668fa3ec1e6509b4f0b899683f892e2037fee25229c71636505124517c89ba4d2f892b21f822890b06da4f07bd7d0ac6b88487805d4481264f1835d65a15b945ecbf3cfd6055ac95f4cfee57df3d6c494bce7665c3ffcb1d2dc0a1d581b8dd0dc7ea9ac033534a3794b7ee66132cc9b99f5875661b624f47e37c8f31455df75bc01c96eecd8ca447ee5940583f249ee1f8034dd7d4adc43d3be3f0742be89a59f3d46cdf58d72ad5e4943e4479b65b066b3b5324f1f42cceea8d6914f6ace762a8293bd9b329df90a0ae2ec46d510183c32c6a32230031ed937ebb217bc1d56fba042ea4856666f425e2c41ccc05a42275a373952c08c7c0f5fc20cbc08083c305e7a35071db095726ad083b0ec6cd2147ac8ae48a61083e373dac46b1f847752f4d8ab0339cef9666ee389418e45f3600b489d6645149bb967b600a537dc6c9833d05a20c841ca0f9802564d3fa68a8083989f533abdd410ccf8ab32d9f9a93823a67e903cb6398f9a5045a445d11d3aa33309449fa5f24177e99ab8894eed2a39c92c06b5d598f288417fa94141e3a46626db38555b7442719ca3a00f441dc98358b9009ecd2a23a1803f711d3cab59fd7a36a708dc4b695496fbd041a92583234d4315d9c6f4eb221b51e9764f1826cfb6563ffaa8e144d5fea22f3ee3d495ebe596a5d163910b2df5a124710c10c325305751f090583f9de36330a76e540d1aed4036e198132121ae8796d3f2c490a5b82982c7bfd433c2ae91c4a55c6243385f0e83099213ef3859bf24a1008fc1295831b173cb45b8d02ba2a2c29d646b785eba960fb40cbb2a1017cbc3f1aa1a1600fca55102dff67c4342568f7a1ea19dd712d5bc94f449d74bc62f692148a081aeb9907b82bc5ca3fbb49ce60101782a3f21c0f5cf600d869fbe51e5264ab71291afac8c878168402f5f46a113f04383eeccdc22ce4a158e6a5a6abb6e1934d043fcc43beabb0d81f45dd1f8cae44e273f527f93240a48471179dbab1c80299afa9b705040e78a1ce66d988e19837303f933554c9b65474796e3d29d8960f25b998ea0fd045fb3bc996775c1cdaae1d8c70c239ad8d9b561c72fa8b7c45c4b077c8d0680617f74479aca51734f9519e4c91eeb4b584a9f907873bf6067fc4bb0d31d49edbb67496355200dc6edaa0082eb8655dcd97c2b995c5959672fa380e4a4f53ebb78c65d71be0a960fd91f30ba90e5ca1974915827a0a98548f29e2888498cf72fef8be984147c312c2dec2ceb98b0c7fa5f8e2bdf8add84cb379944a932537fd608b7bd27ed7c3365924f97274bdf02d132db7c3b12d1f341606288832558d82a6aca2c46c436cc7c7a4e938d44a59c8a72270ec35a8907fd9abc5be53fb57b7d843e9863396f343d0d275aad834fad0e27de624679aa42cdc778295d4a48e2777bae8e30f3c433fbc76814bc876bfe15d42d192f86c7e99e2d847f5016a63e108ed6ef8c562a892a1ddec48fc2f720199ffff31338fcfbf9325c460c2dc539e8907fdb5e7d012c6e70cf4736802f28494c2e4e03a0b0c827f8880e7a2b8495813420d1978b034abd2f3cf5ff75ed74471c9b575bc49bcdd8e39b501c1f0ceb2dadb28df921bec9bd24b170f40bd2a59788d174e29ae53d03c4eba1155ea3186a3460066bc10132c8847610035d948789aaafdf4123fa589f312bd27d2eab33654da69a8c0c3b2b1b8d0bfcf25c628722fc5031c73c0e78dd3cb2c2848824b1110514b58bdfb8132d40386f3f819838ad0bd1af253bbdc7fc69b35ca722528f1bdc346f750a4b544c9c71fe9424ebb5e7c94e6d2dc9413697f9d9f26e79a966ce089a0ed15a6435f543103e1b8991f3c47ee8f294595881f6e271b85ce1ff66a7b4ca19399c748fa6013fb82146b1296df2675a353a56b077ba66fc25ecc4fbd912dc3ea8db789fcc934a7f34bdc6e80f0446514c8af4eb71029b4611e3fce16aabb778b2d27eb1f64b1682999e3ca6e227e619024c19f15802456c1e8093a543ff730e78d367865f366afbf39309c6e7eb0ce0c9a377d796f9686c3db64331160db6406889ab39b9b986089aa9a2aec9b1092a838de9984e0b460436bfc95c9b06dc5e5eb53a75fceb1a326bbdf4e493ce7b7e69f6fcf2aac071877e241e598f5c62d26d7db4edce4654f80bcd6ba2809c29ac031708278ef4a54e42954de15a065fe79c4c5a97cf56ef9a327e13c825f271c2adb1b8542ef3603cfa727e5552a2c34a0b4ac7d89d711a417249357026afd77361b8c41ad0305e0d945d1638c97ad09b89991060fa51c98e03302344618719ff7cff3c7c5f59209f8c6f6c62c57f32355ed470b24cfddb971fe1b103262eba6321d6f564f069eb834c5c0e56994c4e7c06907fd185d131c83793be9d0456aa23c38cf57c7026476142279a1e11e95de9d9c013c8b684b5c34eee771675e815846a26af4eda3042223641476cd8c026d1e3afd7e5b6843a9cc43a1cb7515e171ddfa414dbb21e008cec0b61004bc3d8b4ac358d75d7836da888560fabf97cd1252fd0c8610e83b6b3f07fb61c4ffb0b52f92c03cbfb05cae99c2437b6b7b7f30f4847a93f1c45c5db4697e304e02f67deddc8da5c995dd9d984dfa3751c40e9ff86a3fb1ae663762464935a062ba236479cedeb17d3560d0f3fd15d1fa0b1d520c848935b0e2bc4e18e825eb6b2fbf8992830ed95c311284aed84b859ad6d7da24509ddcaec1c5669a99eb74f8410cdd05dc3ac49fa9d5063984615964404797f4750d9ba2380836b40a1f8d646745777e553797528600dc2cd6f40e97cd53a19119209e3ee0ce274839d4846231971fb024ec2eb7e308647a165dbe6092c36c3af83104d51c4b5c348db6d4ad858750c4a124e10c370e00725093b84ea27f8d936af5186209eb1ccc039ae5d414692ff34991befb86b684a688e602da68c2cd00963ceb75c2983f652bd2a9dc66d9ed08a353c1e4782ec27a05c3cc1b617012f42819d43e44cd6b7e3c76205bef07a484fe4605a4f894a22db514cfb93db96408d648bc054e1670299bc72b4272390a73a4f2979d9644cd1c2e42bc67ff96754a5f406871886a3ca68a017f0bb793533b8f2c17baafc4de5a9d3f71a1f24636571d476919c9edd6f95e348495eaad0d2dcfc3f77c6e1ee1b6149547199a8b3c7d6013235658cc7e0e2edf3f90000000000000000000000000000000000000000000000000000070c0f171c1e263183010000"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

func TestRecipientNormal(t *testing.T) {
	_, addr := defaultTestKey()

	tx, err := decodeTx(common.Hex2Bytes("b91c6202f91c5e010380018261a894b94f5374fce5edbc8e2a8697c15331677e6ebf0b0a825544c0b90a206c5c0256b7e67cb7e89b75395082c19cf08a31bdb0cddaa0dbf9099951f1eaba6b78effac950c20e2f10a07e53303e56ca0228685effffd57eb45677935753560cc2301fcf56c73a80684609704b96a50bb25921492b1fd20ee2dc796d4a9f0c6d1b21875c28081e722470236636ab762f8f7b3451f1c5d1865cd6bc75f9e063a93921f4c263413956931d4e4b951bf0c0915f130f32e9334efdb6df5e761a981e0be8708c07d4948643f85862adecad1008ddd0fd166e7933230d8683944959d99f22b61c59542e90caa92c43a1dabda2259029fa798d2aa4226af07ebf1de625603d173833064141bafeb367f2a5df2c177f229dacc119c5a94649a897a01289d4e0d4ace80868153c96fcdb03b4f3c8aa8fdd6b8ab74366322454e400fd2301e30912f6dccaae2647bba0f4b2e893c50f24ac81fb2b9f2fd6ccb8f4e6e1438054dc0284650ba99320654140da53bc57b927bdea089557661056290d826c547483839f8ab77467d959ea0a4bdcbd955b96e27e1d775ce35550f5dfcd8c4347609b75f8fc9746ceecd2da06f36803988a9bf902ccb27c1602333cdb9ff2e4409a7993fc5b54d5d57d1de56564e0885f1d71ee7144df744b0960f753d973d832cc1b7b761282a366abc3a42866b26b8c84518fa05d6a152f017e9bcb466575a470db29f5d7451ff3ae88ff706e9b71e2da68b4eafb82cda58b7ca208685e4c4caeab1ba4a79622e85c08826effe2224f2f16bde95b6a7cccde9b469e9b991e4ea8fc3f1eb54a8fa719af71d321d7b893e3751173f9ef2c48200695f1e29b17597dd5450dd43b3a04042c38f2c602c88ffa4e3e96f1611a43ff6c6734b63f685a9818c9354b900c2d2474afae0728e69e0ba93a9d8c782011fb51e7c6728fb940fef69701a9b32e8527c0a47f8a70f896f5700219215e78cd776ef5079fb6ed9caf20f93c50e20a6e3e7bff8c9b7bbd800e1e59139a3ab3aa5d4018dcbc7095b0d017b77185cc5400693992b1ce633b8d0406b3ba97573108cff5a897b06992bd6385ab5f3537f20d607788d4f0f956103506a0337295915fbe02851b9fcf32e8013a9b433c3250f072571b148436c898e6e78bed671c37fc467491254f68debe627b114c5cffeb1935312fe5abeb4ed22771a35f4aae9b64399908d4be447566e4bddb5ebf2b3837a9b99a7dc59cadba535a77814a43000464cb35a2998688fb2ad2eb66ed367807c9d92e9d776ad2895fdaf12d37cd8c61ff46d027d9adfc0316ec5f3b52f80af2614b18f1d7bdbbda4dc35ba5363d960399042efc1a1fd41f860ed1422ee84e73dc12f1f2eb895d59660c11b1edb72509e5b2212716b055fe52e5a58c3e9b5d22c6d9dc4ca2a1f205d65bc4f9f24f44c72cf42d9b8b91c65858332bb24324b47877aafa523f880cd4724ff990cd2b079105071df7ee90692f43ce23e71a8bc0745984e652b65e6013385e81d44563491f546b0064e9cfb7643da4393cf6b3a7afd4fec232016700c65a8531a88e213a9ab5546255528fc0ac9992c46c1f2ac3192adc32423dbe052dbe33e46aa6d369717c74da5a8eea8e8e281b1f37c8352d2879e4ca9b8e3e0ea3454744ba8bec5434cd3ade1c783085a3dfeaeb90703cca8d0b9fcd9ea063b2ae88ded6b84f9a1498252483a5c7583756631da66bf81ec480478204731baff7f2f2e8cd6ee8a2a76d1dbaed7a8254eb002cc18fd65b57f7982176242e546fda668458378e52eb25ccf149ca097381a878643a34c811d4391474d5d09f5d4317815fc02095cda18372d72ed60d35b70c6554bb91dd8ea4a948ffbeb1bbb130b1109cf4d1702070bb8c9572674fc1df859d9aac67a541af321aa518b1d0de130621141f6be4ffc9226afff782cd2ebb9b1f87162cb32c7df2ee2931a55dff603dda6f81bc1858ab48044c1e6c45c3740c8386d8c357ec0d9dc0ff9ddd7f38ebab0e9f6e6d0f23c944a059109d332e35d2b786fde3df1975b761cef5d52df5f837315c1218d9003ea916f3dd98f926eec8781dd92e726752095e2388cac1a3c8b41da90af4942f8e734105d3b8cba0f310dd38267d2d53e0aa00780efcebbc267ff9bebc980918bdd1b4f42655d0671de9b762ea98ec55fd5d07bb102aeec85903f6653f47ee4951213170bbdcf35a276e0fc4a10df4077b14e9c326890fc502dd5422fc601ad76d45e2ac2f9cdcf1802b4fd2f54af989b0c4087feb032dda3fac5b292af1fbe53013acf162d0a7cfd908d7be37d78904161a04e6f67a63350936ba9d0a94b9400777a3cf2e5c78fc9ea4d0b2de1bd80bed2f0b2201d78a45f37099f912da6698f6bc1eb5a98bf11bd7f3a06fe95a7211a52410913d5ba04d1f80ae24fc499d380980b324ea617def1fd7b90e15df83cd0233f9cbf603aeb41f8f2f3d796596edbca55d385e2620542ecf4fddcee771a69642e7c7bbd2b20acf2774f3e9b0e9adae01ddb5925350b9977ea53071b0db3306dd6dd7c667225d540595013398205381501203bb05bf7c44738936014e1ad5214e2f26059d11f986bdc234f9da8860548e1ede1ca0bf87a010b503f2346610137bc7df2295bb5de4d38c5dc73a7738294232cae9effb82e5a7f012f7b15e223925fb9a1b998545efc28b76a2d9361d545d603cbcc019f70ff073d16c5e2727f123d95eb42339ebac494ce7f28555aea065e6161486fde260a02024f15af6592892934e9fab09025c0ac606e0491e965b58d1dcf60058059e4726728e037a698cf74bf2f2f0f4f9bec51cbc035f32eb3e617cb892af5406e6f3ee74e177a1bb07d1d3b5f80cba842d6d2e7eeb5b2ad7bedb0d9f5e6255033b1bc187064b19b72a2eb926961be1441426200ce27893e30cc217e0a8a9c33fdc22e7c94b49ef094443fca1e528035ec04c83f187686d22862ffcd9edf223d2d1d86da65a597f9f1b784395541bb5d960c1bbc34d0c15404182b3746f875b06bd5f4d41ccb58ed03de6df566cb85595b21ce3bd7062a515bc365c925965e8800263731618f70258a731e41eb45a7d8e19cf18ee8ff0eabb0dd7c89e0f6aacce42dfeee14704d53105f81b627fdb6399c23d330d8ed169e4a76c3d4158016afafdade3b725bfbfcdd8457eef2a8f8566908da236e3a0b35486e0cc979bdcef27329d354624f346a308470d813b28d204b7fab4613243b37ccf92b347390d1da0bf902cd4803a9aa54fd46fc85ff63cae54ce45785aff19cf6b1cf7ada4f3fdaeafc8989e7c9221efc0d5048c6b873bb9951729f92aa097393726a1e904460eb6344a7f4c8d680c0bafdd2f80ac559d82b4970153b87fb7724ac9c92a8dd35c8ebaff1f3d99202d8456d3ed4fa8728f1d4901c883e7cb26dbf804871e4170b6e274c1514d5a64b3c8f4bc70ee41bd0bbc44c1ae016e9bcdf6e71158d37623cf40a64cdf9fb4c230ca8680cd74d49de200acb00ea38117dd8cb246d421b29c355de0cee7b0de003e3c55821a067d8b0b5f8b01a4e5634e48131578a89870e059fb4794d45ba0713179a545a2ffa43d92f178dcf7c6f05c80aca3a6b16419f8d9f6d118caaa5a59535b3211b8ab651de3444ff1205c38df1f7d6b6bf96e04a7d2141a248e0b39619f3da001c437ea752d9c1605d4c11950ffeef401dd3608f368b4e365e9b912136796987f4b93f3b88dac861c6b4a4a56a5a67db9d65139db334d2eb334890e3f1a66e3c1d9d6e151e74a46fd4ea0becce30b53c77ef47d338cfabdc6ccff6bea42340bfea98d273ac0edd855f65ac6d39a71bcc22db4cff817d5fd034c25280c9aad272ba487c05b8481d28ae923807aa997f679bda96c91853fbade4ebbf382c06eb32d664aa33b4b3e018c50dbcb012b5cb30d65f069b8c19d7a4fa3af61eb99ae6544fded89b7eb6bf8edbd88011099b2552fe46d0b186104b91b3813051aeae51cba389c7d2642978877afd85f62dfed879a52d79709ee97c8f3bdb2340e9e321fb170291baf0d6cf3b35d06f014aca4179e98c35bd271cc3f994bf6f04b3b12c9fdd3ba20bd56006210d02a1cc7dbff7f4cf7a635157a9f5b6ceabc8ad107f955e2b8333d7e92bf8eb7f7f22f26d11cf029091bb7010d2e953f08742dcf2bddd78c939e7003af5eece2c5d9ea31b614a49053b44c71b9ec774d37b26fa5076f7b3879adf55b760d657c2fcea2148ba5dece4704c2d437e4ad3d768059754ffb5851b0e3959276fbeeb3a7e46ac7577462c209ccad04d0945b088b27860973690b1656b2037774822559e359b76c1d661b3e7b7a225d807536cbf98abc30c7f7e3eaf8e2af675cd31c03e2558bc2f3ebd66f69a2e23a000131db28cb089c5cb5956db98fdc733ff2c0c2776bd9b0bb3017190ce4b2d767660b51c62a2ff1096772386eb552ba5cd898b6965097cee9e0308190f5f691b537e47d8bca2aee06e7731d30ecf34b0b9cc72fb0dc290c3cc8ed6cffbd2dc06bf6a405199dbe4ce2eb56e8fe314a027ce0d9505866dbb467f598312cee3ad123e20bb59485ba9394598b1f67504a11f2fce8b3421697a2f73c9c1fd58eff1d1885c07fa19c03265b667c7e71af7f9f71f821eec154b2d25ace780a8414a458165890a6ea48d19428adf45dba7dec7c3f730b392cc86a2b0c9ecd9edd3f831af2865471085e5285e5d61855c28f878eea96b4b03a73ea94b0578ebe8fb3de574461b0287c2ec20eec1d46d7433f1dd3eb611224d72c06d13b80d974bf009826d453102189ebb19d50372da6736d9fee8735ffcb049384932f1f8a1a26f732fbb3b72931aa87fe9d75947e793413671f4232a94c6e1b2d9d27be13b665d8ddc509573a562e2443fa6b672fe4ce31c46a6b47be7d673b1b93fc42f063f50c31b6301943a74d506e80f947dc7f1806b8daf0901068cdf08c71af7008bd45919cd42471730752ff7bf3f4151296d20924fc4b7735f9c9696e2dd7eb3917786d7db3d93d5f3f8da49df538ac7af7255106b84380265064409ab340298f05ef31ba2c255d413b361ad57017ed73cfcda830e93bbb5c62d9a7010ee25c943d3d9bc5eabb16de9bcf2a03859b4f25f9c4835bb0bac970b82d639861892b76486233c43118b74619c5d6cbcbfcb86f2489b04068a3e65ef4a43507d2094cb1ae59eb45a5015dbe74494dd56bdfe592cfa1dfd0befaccb8cbe3533f2ee8297afe8d28158b351112f6694ec49684fffc9c1d9db167a9f6f3fce532bef81afa3696be20e5aaa3c322ff3339e0b6d74f0dbad1eaadb77a2e57f9e86dcb8b681b4b7d1f73f774782cb0e8b5c52a374f8ebd998d61d9cda37a68ff9c3fb8f33258852ea949c281eb047cef108e2c587040ec2df518a0ac4675acbf7c39e40e66d307e8635899f5cd10f25bede0ae14b968e2f74ea862b1ae71d9e4d0dae8770b1d64c8f9c5fad0bf255c036774b5633bc892b193475dabe4cc0511892bdbd62efe90d406d7e11c4fed1d9171c91c5d81dbc1f1b81ca57c97761cd0567c7f11f201a716268c6330e90d04babb58374aed005970f1e2ad06c106470365873060f82b9a1e90b296adbfc6834245eb33bab719cd82242740bdedd4d29c2bd01570a7b3a73aacaef0f37498a38bc6b9c4427f44d49f7502c8c9e2807850c6c862267c7c6c1e5b7d0aa2e5b49f1ad90ef2c52378bb32375adb16be3e39a40fa462621c5896c50b457e6bf8eb8d8958c70fdb24675c3d91671181deef41ebbd8804d8b214c3fedc7ec8db4c7ed4c10c50b42ec6251753addb7ecb9bd1435bb7d575fd556f6772d4856a2c8a479a448db49a3492b8aac2d1aab368a1ee55f087aaa452b489e1456bee16df8bdc083056d20bbd92aa7864180e26bae9571c5aeef213fc68238977fff1fb2885749c0bbd16a6f2eb4e25404cbe719e8581a35fb595fb3757abdffc96fe0989de234cb444a3bba7559fb10d9954f2a36cd501bc726367f5c4da4c5952ff9a5a2625f8d19492605e66889b4b1d84cf72448dc84475a2ccbb0970f426699d0f5306c5eab4be017d695d5148f05e3770d23c3eb8878813eb0cbb6a59c095780711fb568c94814ed9158bedd86df75cdd0d813fdebb607dd383ac39071e37f780c206a923b1dcc194f351ee0e5de40e914a7801d8d0f3f9146df591f5c24a4b6ad021058cd0640614081e05da20a06b5f0b369f2877c8b3ef49f93b8518ff4117490d2409b04971df51eef8e66e71c0571a4dcca80c1ed784f5e8a1576cee3c4e79f84a1fd1d664ea38a576b32a85a96c8a10f228923ce164d50637445a4b8f3dc65d146bf5b8df127360cdb7ebd2e219a60489960707f2078ae7ecf0b94d66cc9303d178e33614e7e0ad30f46ac6d4a8689320b5191df15f61f950ddca60d1b05fd2b55dd21d4991a1d6da179c1251d97150c9e67d17d8963d4ab8e382c1fa1a0c5da2865b201657897ee4b9d080c8a9335aef53cf538cf55182752fcb48d330f475e941bed431dd5cf69a1c2157f69f714cf2fbc6ada3a1bf6765499624f80a54e921cc60e8c7e1ff7614badd3830eb485a1b1941f0741b22e3e44b4dca8a4b7b710140e5ea727c4dd9557119adda016ff3b718a983af95b3fb15670aefeba4db5a959e84045d498a2a803240f62ac3c88fb896d7aa69ba5b5629a8bc85ece6134c2037550db56ddce96b610dde7a76e0836d629addebf33479b0a2c7491d13101ef588ad9635e6eae7999956ecc7f48a5d440654b3803172ff053aee67b2489e63eb4ab4214507ae2989b1e63635274401f7f7d19748963477e0d93cc200401a22646079ab6042abb66458424ca3fe636b6226be00e07df7ef8719ad5fbc03a60d5aba09af2c60783b64185d9f07c3af3c1dd0e6bb02968cfb495d3accdb7138e4673b3ad327e4f4ea83f635db26962842769f413c98343d5b047ea24067b41dd5a85c3f61613a0053287d320161b9dc2e3e74b95e1b1a69369fe615861d5d1711155e2662a07037926eeca3b34869a6900716f12628c0c744a348f6fbd2bbb9c10605d89f81340f0604d0d6a8c654832f5097cf50dc4f1cdf80453324a99aa3fe9b48a292482cc0eedcd55262aa729dea293c77cb4de4184d65e9110174db1e0e04407d8de20a5e7d3843346f04ba20b6d53fd3ab5f47e0e2690224f8f1e50bf85b69ac02bb90e8413791ad318bf6900b379bae710f3059b92186e35bfe1819fcdb64eaca6edaaf23c24a2612e123b634b516ac7ee32caa1e3992193067fae120374340cbc329e0ca8ce0c5b6619fae066bff45ce436d50b561c84abfbc41013b01c5b68e441f93ce389c7bbf1b360a1a1e4ff3b74e03832391689a6d17ef82a565136909092fba3828cda3b9fece2872a9083b94d524c04d5d19c974840d7340d8ad17497f4d3608806c4c2e380c8c6c87c30dfda07aa4b64101ed0361019cf49b95ac062885e183fedcff1ddea11426cdc6784e8025bec2534342160aca7cc42ced2212c2ad5f51ce693162d5af2a52d10f27cb9ba7efba4c42568619c0727020088653acb7729bba87c0f29f442a9c153e54dce4edbc094664317cc325f7549da92ecdd1e80127e723c07c4dba873673f0a49b615c7b838fb0b6b4916d0ed76641cefa74378ec6e1faae677af17002390b2af042316cc1140a1f9e022645d1eade079b718bd5ba7f252f57c161bd14944a938aa3dc6b41e811d0e7900c370ad4da626cca3d9d078d9a96ca5f677cb3879fdec1e7ef2d3a1344e4ad1af01c49ce0aae36406b77a13d2b4adec04cf78ca1617ce24a15f148b6ced32baab2d04fc084cb8d6f0c096dca50b8574e9030ba61e9b7dae2cdbdb84e78d811bd41a59f33c1a418e7289c7a7076640c06e887b425640274c1a69e5bedf2d13b2475d368408345a8371209e49c75f6e18e1335efe4ab3e3947f26c1c092849c642774c33ddad703b578240f2902d93a0d26cd7eb47efd1c838a172b314c46a74cde4bd90513852cf1b7ccb15694047de3de4225924532775f07b805f10b169cea24263b3eb1b486c1c898376136583e1f486a9b1a8e9ad774e4eca1aefc94f9262191951c6cb8267c281c989c162382d379350f61ea18cf824bf0cc77f186182e92a9128f2a522177a8c816de5f5b7c396ddc83cb974368b1c0b8c3a3395d8bf49fef9e420ba51d59546c4dab59b17e907f737f70469abbcd016cf9324da97c2391fe4fddee04dce7348800e6d7bdb4f6af20b5b05a63b55d8450dcdfd7f44fd6feeaa68d591e2cbb76b597cda655e6ff59db1fcebdb2aa8c8f5f109b71d50c58f5cb68a1f0d27b331b42a617eaee6762025882a04d55568b824f651dc5dfdd67cda6e02dc5610c53d68f00a79f3ad9ac0b83c530860c625de08ce04b557219ef966b77281eeefedac40138833b918187c881fb97e38b9262517f4a33c700391d6df5affb6476a76e7a05cf38a429ebbb635a1d8771649b6557a658dd11dd2409f35dab53d2c9de483126a2aef59497dc83808084b37f05dacedf0b538d8032f165e458427ceb155764b557db7415757b065f7a8028c2ff88d7ba713002caa086c1a3404c1cb8ed9b32053acdd0124a10988c784befb6274a540be1edd3ad555b4b12a0ca88f12391fa1dbe61460d7bc73e72333a79270b888eaa4ed7b5cade8e4b22707e9390e9fd6231ede8b24fc19f48002799914d6da4141c671edaec3f7405a30b30b4fb7db0211e3b73e141be2f5299be20d1bbd604ba8a005ee0b6a1b17577fb5650cf00a15508994a6d77239e8a856da22cc66e3900a38db961a2fe0494d4408c3162c469e1e424a5d76131f1de420bb600cb0003097832bc5336b13931cd0551169538d06a5dd2b1eef54fba4d8dc4ae8bfbb566eefadbec41c8dcbea2474233b240bc2a4e7c9cb544676b4addba555016dd4f148070ba6ca8e0acb88bcdb5f23915b05f1aaee8f2d769c5e9b2993b2a493cd53060e7d6be8917aafb04be35260facdba7adc085a42c9df92ad126153acd46f953c4a186a888da19865650a962338e7112d9c9d1519cd802ac34c11ec8b8c1194a89fadd8d5f586d07f204480b450549e4cb0d32260f8cd01e5dd9833cd6f2581bcfdd563ed9a8d1a7b2b80113a32031a506a2ac069836cbe5cd63d1b3c8b9d09bda21c09e186cbbb8f1df3d964fd1698a7728b6c1c2a73d466e6ccd06980d4f2256af569787c834615c7ccd9298a72bc23b0a783de62e87773e2c11c6d2509d7f277e47b7b812811d381023da51a35e85c7bfb9963200a60b01afc8b87abd17bbcdc2bf6b0ebcd601e083565e662cd2db723a8d3f72c395327313375a3496988324240643d9a0779ed06d79db04229a06257a7d223f44dffd607b575b90319af6d5e76ef0ca0848d502451b9d76d8dcac41473e6114e280fbaba73f041581fe956832d67530777b3f6e86f14a6ac0152797ec1b659ec495537ecc7af811e089f26c6a81113d4bcde95d7282a455dd91078d4f3865f38da0fabbef9114723a6689371dcc721081e10eb27d33399aaa7e6a1fdb4b81fbadf56741088912e6256e89ee4aabb2ad78e738436123bd3fc3a20646d95c4383b31d1b354391ea0ac3be99d65867d464521eb82fb303628926d320ef372ea6c59232c82004759d08597c1e7e958b2a26cde49743002a92f99ef9a5b10153065b1b50094d4427c22d24d1d1969f3f59ac2e6beeeba4f04a2c628f47796c5ae530c1b689d1f2f5b2ba9693b23c1e5101fed08be1674cee3e433ba3e4c0265de716be96116597681fcb34f7e6cf3989ca8855f6bb73630d0498da60df06e025eacc754acf2e3ac2eae7544f64db9d334519d6dbba7c3311c23793cfd5c9e73023ec509073ee9d9e163a308e5f7d18999b4a4897b0d50a526de5516cb0b4c9f2c48187f7414efd9bd3638b24814f350f8e8ca5e44f1f1e0a64793314a91cbcf27fdb9110f9d3a8b5ce78acce62244ea757d9afbd7cfc490847a2beca17a411978f19176072518158e115be6c4dee97eb07b543ce98810b0d6a15dcccdc08f1000f63c818b13c4b4e62221c7932de2fe686f8702a8b0ecb04d4dd70bbaba389a2d183e8fb37cae944b50d36376e43292f1478ce94ac9ada542332585218ae2f31f283b3ef91a2021314c535c7b91b5c51b464eb1111d35565c8286a4e0323fb4f3f809111223576d848aa9e5262b4f80e6ee060d224c7400000000000000000000000000000000000000000510141d222c323783010000"))
	if err != nil {
		t.Fatal(err)
	}

	from, err := Sender(ShanghaiSigner{ChainId: big.NewInt(1)}, tx)
	if err != nil {
		t.Fatal(err)
	}
	if addr != from {
		t.Fatal("derived address doesn't match")
	}
}

// TestTransactionCoding tests serializing/de-serializing to/from rlp and JSON.
func TestTransactionCoding(t *testing.T) {
	key, err := pqcrypto.GenerateWalletKey()
	if err != nil {
		t.Fatalf("could not generate key: %v", err)
	}
	var (
		signer       = NewShanghaiSigner(common.Big1)
		addr, _      = common.NewAddressFromString("Q0000000000000000000000000000000000000001")
		recipient, _ = common.NewAddressFromString("Q095e7baea6a6c7c4c2dfeb977efac326af552d87")
		accesses     = AccessList{{Address: addr, StorageKeys: []common.Hash{{0}}}}
	)
	for i := uint64(0); i < 500; i++ {
		var txdata TxData
		switch i % 5 {
		case 0:
			// Dynamic fee tx.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				To:        &recipient,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 1:
			// Dynamic fee tx contract creation.
			txdata = &DynamicFeeTx{
				Nonce:     i,
				Gas:       1,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 2:
			// Tx with non-zero access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				To:         &recipient,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
				Data:       []byte("abcdef"),
			}
		case 3:
			// Tx with empty access list.
			txdata = &DynamicFeeTx{
				ChainID:   big.NewInt(1),
				Nonce:     i,
				To:        &recipient,
				Gas:       123457,
				GasFeeCap: big.NewInt(2),
				GasTipCap: big.NewInt(0),
				Data:      []byte("abcdef"),
			}
		case 4:
			// Contract creation with access list.
			txdata = &DynamicFeeTx{
				ChainID:    big.NewInt(1),
				Nonce:      i,
				Gas:        123457,
				GasFeeCap:  big.NewInt(2),
				GasTipCap:  big.NewInt(0),
				AccessList: accesses,
			}
		}
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("could not sign transaction: %v", err)
		}
		// RLP
		parsedTx, err := encodeDecodeBinary(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}

		// JSON
		parsedTx, err = encodeDecodeJSON(tx)
		if err != nil {
			t.Fatal(err)
		}
		if err := assertEqual(parsedTx, tx); err != nil {
			t.Fatal(err)
		}
	}
}

func encodeDecodeJSON(tx *Transaction) (*Transaction, error) {
	data, err := json.Marshal(tx)
	if err != nil {
		return nil, fmt.Errorf("json encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := json.Unmarshal(data, &parsedTx); err != nil {
		return nil, fmt.Errorf("json decoding failed: %v", err)
	}
	return parsedTx, nil
}

func encodeDecodeBinary(tx *Transaction) (*Transaction, error) {
	data, err := tx.MarshalBinary()
	if err != nil {
		return nil, fmt.Errorf("rlp encoding failed: %v", err)
	}
	var parsedTx = &Transaction{}
	if err := parsedTx.UnmarshalBinary(data); err != nil {
		return nil, fmt.Errorf("rlp decoding failed: %v", err)
	}
	return parsedTx, nil
}

func assertEqual(orig *Transaction, cpy *Transaction) error {
	if want, got := orig.Hash(), cpy.Hash(); want != got {
		return fmt.Errorf("parsed tx differs from original tx, want %v, got %v", want, got)
	}
	if want, got := orig.ChainId(), cpy.ChainId(); want.Cmp(got) != 0 {
		return fmt.Errorf("invalid chain id, want %d, got %d", want, got)
	}
	if orig.AccessList() != nil {
		if !reflect.DeepEqual(orig.AccessList(), cpy.AccessList()) {
			return fmt.Errorf("access list wrong!")
		}
	}
	return nil
}

func TestTransactionSizes(t *testing.T) {
	signer := NewShanghaiSigner(big.NewInt(123))
	key, _ := pqcrypto.HexToWallet("b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291")
	to, _ := common.NewAddressFromString("Q0000000000000000000000000000000000000001")
	for i, txdata := range []TxData{
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			GasFeeCap: big.NewInt(500),
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			AccessList: AccessList{
				AccessTuple{
					Address:     to,
					StorageKeys: []common.Hash{common.HexToHash("0x01")},
				}},
		},
		&DynamicFeeTx{
			ChainID:   big.NewInt(123),
			Nonce:     1,
			Gas:       1000000,
			To:        &to,
			Value:     big.NewInt(1),
			GasTipCap: big.NewInt(500),
			GasFeeCap: big.NewInt(500),
		},
	} {
		tx, err := SignNewTx(key, signer, txdata)
		if err != nil {
			t.Fatalf("test %d: %v", i, err)
		}
		bin, _ := tx.MarshalBinary()

		// Check initial calc
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: size wrong, have %d want %d", i, have, want)
		}
		// Check cached version too
		if have, want := int(tx.Size()), len(bin); have != want {
			t.Errorf("test %d: (cached) size wrong, have %d want %d", i, have, want)
		}
		// Check unmarshalled version too
		utx := new(Transaction)
		if err := utx.UnmarshalBinary(bin); err != nil {
			t.Fatalf("test %d: failed to unmarshal tx: %v", i, err)
		}
		if have, want := int(utx.Size()), len(bin); have != want {
			t.Errorf("test %d: (unmarshalled) size wrong, have %d want %d", i, have, want)
		}
	}
}
